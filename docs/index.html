<!-- Standalone Generated By Octo (octo-ide.com) -->
<script>data={"program":"# The program begins from 0x200 with the CHIP-8 logo image,\n# which contains the `main` label:\n\n# CHIP-8 logo ROM by Timendus, published here before:\n# https://github.com/Timendus/chip-8/blob/master/octo/CHIP-8%20logo.8o\n\n# 132 bytes, 20 cycles to show \"CHIP-8\" on the screen\n#\n# This ROM is simpler than the IBM logo in two ways:\n#  a) It does not use the addition instruction\n#  b) It only renders aligned sprites (all coordinates are multiples of 8)\n#\n# Uses only these five instructions:\n#  * Clear the screen\n#  * Load normal register with immediate value\n#  * Load i register with immediate value\n#  * Draw sprite to screen (only aligned)\n#  * Jump (at the end, so kinda optional)\n\n:macro show X address {\n  v0 := X\n  i := address\n  sprite v0 v1 15\n}\n\n: main\n  clear\n\n  v1 := 1\n  show  8 logo-part1\n  show 16 logo-part2\n  show 24 logo-part3\n  show 32 logo-part4\n  show 40 logo-part5\n  show 48 logo-part6\n\n  v1 := 16\n  show  8 logo-part7\n  show 16 logo-part8\n  show 24 logo-part9\n  show 32 logo-part10\n  show 40 logo-part11\n  show 48 logo-part12\n\n  jump select-test\n\n\n\n# After that, if the user auto-started a test, run it:\n\n: select-test\n\ti := 0x1FF\n\tload v0\n\tif v0 == 1 then jump ibm-logo\n\tif v0 == 2 then jump corax89\n\tif v0 == 3 then jump flags-test\n\tif v0 == 4 then jump quirks-test\n\tif v0 == 5 then jump keypad-test\n\tif v0 == 9 then jump menu\n\tjump menu-after-keypress\n\n# Include all support code:\n\n:stringmode str \"$0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ -.\" {\n\t:byte { 4 * VALUE }\n}\n\n:macro text X Y STR {\n\tvD := X\n\tvE := Y\n\ti := STR\n\tdrawText\n}\n\n:alias x vA\n:alias y vB\n\n: waitKeyRelease\n\tv0 := 0\n: -\n\t\tif v0 key then jump -\n\t\tv0 += 1\n\t\tif v0 == 16 then return\n\tjump -\n\n\n# A cute little menu to select a test\n\n: menu-after-keypress\n\tv0 := key\n\twaitKeyRelease\n: menu\n\tclear\n\ttext 10  1 menu-header\n\ttext 14  7 menu-ibm\n\ttext 14 12 menu-corax\n\ttext 14 17 menu-flags\n\ttext 14 22 menu-quirks\n\ttext 14 27 menu-keypad\n\n\tv1 := 10\n\tv2 := 8\n\tv3 := 0\n\ti := menu-cursor\n\tdelay := v3\n\tloop\n\t\t# Blink cursor\n\t\tv0 := delay\n\t\tif v0 == 0 begin\n\t\t\tsprite v1 v2 2\n\t\t\tv0 := 10\n\t\t\tdelay := v0\n\t\t\tv0 := 1\n\t\t\tv3 ^= v0\n\t\tend\n\n\t\t# Use numbers to start test\n\t\tv0 := 1   if v0 key then jump ibm-logo-after-keyrelease\n\t\tv0 := 2   if v0 key then jump corax89-after-keyrelease\n\t\tv0 := 3   if v0 key then jump flags-test-after-keyrelease\n\t\tv0 := 4   if v0 key then jump quirks-test-after-keyrelease\n\t\tv0 := 0xC if v0 key then jump quirks-test-after-keyrelease\n\n\t\t# Select test under cursor\n\t\tv0 := 6\n\t\tif v0 key begin\n\t\t\twaitKeyRelease\n\t\t\tif v2 == 8 then jump ibm-logo\n\t\t\tif v2 == 13 then jump corax89\n\t\t\tif v2 == 18 then jump flags-test\n\t\t\tif v2 == 23 then jump quirks-test\n\t\t\tif v2 == 28 then jump keypad-test\n\t\tend\n\n\t\t# Move cursor\n\t\t# Up\n\t\tv0 := 5\n\t\tif v0 key begin\n\t\t\tif v3 == 1 then sprite v1 v2 2\n\t\t\tif v2 > 8 then v2 -= 5\n\t\t\tif v3 == 1 then sprite v1 v2 2\n\t\t\twaitKeyRelease\n\t\tend\n\t\t# Down\n\t\tv0 := 8\n\t\tif v0 key begin\n\t\t\tif v3 == 1 then sprite v1 v2 2\n\t\t\tif v2 < 28 then v2 += 5\n\t\t\tif v3 == 1 then sprite v1 v2 2\n\t\t\twaitKeyRelease\n\t\tend\n\tagain\n\n\n# Font rendering code and character data\n# Kept this very simplistic and fast\n\n:macro drawCharacter REG {\n\tif REG == 0 then return\n\ti := characters\n\ti += REG\n\tsprite vD vE 4\n\tvD += 4\n}\n\n: drawText\n\tload vC\n\tdrawCharacter v0\n\tdrawCharacter v1\n\tdrawCharacter v2\n\tdrawCharacter v3\n\tdrawCharacter v4\n\tdrawCharacter v5\n\tdrawCharacter v6\n\tdrawCharacter v7\n\tdrawCharacter v8\n\tdrawCharacter v9\n\tdrawCharacter vA\n\tdrawCharacter vB\n\tdrawCharacter vC\n\treturn\n\n\n\n# Include all available tests:\n\n# Disassembly of the famous \"IBM logo\" program, published here before:\n# https://github.com/Timendus/chip-8/blob/master/octo/IBM%20logo.8o\n\n# Annotated and converted to Octo mnemonics by Timendus, in the hope that it\n# will be useful to people trying to debug their CHIP-8 interpreters\n#\n# Original \"IBM logo\" MD5 hash:       2dbace8066709ac9a264d23281820d32\n# MD5 hash of binary from this code:  2dbace8066709ac9a264d23281820d32\n\n: ibm-logo-after-keyrelease\n\twaitKeyRelease\n: ibm-logo\n  clear                       # Address 512 / 0x200\n\n  i := ibm-logo-part1         # Address 514 / 0x202\n  v0 := 12                    # Address 516 / 0x204\n  v1 := 8\n  sprite v0 v1 15             # Address 520 / 0x208\n\n  v0 += 9                     # Address 522 / 0x20A\n  i := ibm-logo-part2\n  sprite v0 v1 15\n\n  i := ibm-logo-part3         # Interesting mixup here, swapping the operations\n  v0 += 8\n  sprite v0 v1 15\n\n  v0 += 4\n  i := ibm-logo-part4\n  sprite v0 v1 15\n\n  v0 += 8\n  i := ibm-logo-part5\n  sprite v0 v1 15\n\n  v0 += 8\n  i := ibm-logo-part6\n  sprite v0 v1 15\n\n  jump menu-after-keypress    # Address 552 / 0x228\n\n\n# Corax89's chip8-test-rom, published here before:\n# https://github.com/corax89/chip8-test-rom\n\n# MIT License\n#\n# Copyright (c) 2019 corax89\n#\n# Permission is hereby granted, free of charge, to any person obtaining a copy\n# of this software and associated documentation files (the \"Software\"), to deal\n# in the Software without restriction, including without limitation the rights\n# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n# copies of the Software, and to permit persons to whom the Software is\n# furnished to do so, subject to the following conditions:\n#\n# The above copyright notice and this permission notice shall be included in all\n# copies or substantial portions of the Software.\n#\n# THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n# SOFTWARE.\n\n:alias x0 v8\n:alias x1 v9\n:alias x2 vA\n:alias y\tvB\n\n:macro drawop A B {\n\ti := A\n\tsprite x0 y 4\n\ti := B\n\tsprite x1 y 4\n}\n\n: test2X\n\t#test 2x\n\ti := imageok\n\tsprite x2 y 4\n\treturn\n\n: test1x\n\ti := imageok\n\tsprite x2 y 4\n\tjump menu-after-keypress\n\n: corax89-after-keyrelease\n\twaitKeyRelease\n: corax89\n\tclear\n\tx0 := 1\n\tx1 := 5\n\tx2 := 10\n\ty := 1\n\tv5 := 42\n\tv6 := 43\n\n\t#test 3x\n\tdrawop im3 imX\n\ti := imageok\n\tif v6 != 43 then i := imagefalse\n\tsprite x2 y 4\n\n\t#test 4x\n\ty := 6\n\tdrawop im4 imX\n\ti := imagefalse\n\tif v5 == 42 then i := imageok\n\tsprite x2 y 4\n\n\t#test 5x\n\ty := 11\n\tdrawop im5 imX\n\ti := imagefalse\n\tif v5 != v6 then i := imageok\n\tsprite x2 y 4\n\n\t#test 7x\n\ty := 16\n\tdrawop im7 imX\n\ti := imagefalse\n\tv6 += 255\n\tif v6 == 42 then i := imageok\n\tsprite x2 y 4\n\n\t#test 9x\n\ty := 21\n\tdrawop im9 imX\n\ti := imagefalse\n\tif v5 == v6 then i := imageok\n\tsprite x2 y 4\n\n\t#test \"AX\"\n\t# Note by Timendus: I think this really tests 2NNN, not ANNN, so I changed the\n\t# displayed label on this to not confuse users.\n\t# See PR: https://github.com/corax89/chip8-test-rom/pull/9\n\ty := 26\n\tdrawop im2 imX\n\ttest2X\n\n\t#test 0E\n\tx0 := 24\n\tx1 := 28\n\tx2 := 33\n\ty := 1\n\tdrawop im0 imE\n\ti := imageok\n\tsprite x2 y 4\n\n\t#test 8xy0\n\ty := 6\n\tdrawop im8 im0\n\ti := imagefalse\n\tv7 := v5\n\tif v7 == 42 then i := imageok\n\tsprite x2 y 4\n\n\t#test 8xy1\n\ty := 11\n\tdrawop im8 im1\n\ti := imagefalse\n\tv7 := 42\n\tv7 |= y\n\tif v7 == 43 then i := imageok\n\tsprite x2 y 4\n\n\t#test 8xy2\n\ty := 16\n\tdrawop im8 im2\n\ti := imagefalse\n\tv6 := 120\n\tv7 := 31\n\tv7 &= v6\n\tif v7 == 24 then i := imageok\n\tsprite x2 y 4\n\n\t#test 8xy3\n\ty := 21\n\tdrawop im8 im3\n\ti := imagefalse\n\tv6 := 120\n\tv7 := 31\n\tv7 ^= v6\n\tif v7 == 103 then i := imageok\n\tsprite x2 y 4\n\n\t#test 8xy4\n\ty := 26\n\tdrawop im8 im4\n\ti := imagefalse\n\tv6 := 140\n\tv7 := 140\n\tv7 += v6\n\tif v7 == 24 then i := imageok\n\tsprite x2 y 4\n\n\t#test 8xy5\n\tx0 := 47\n\tx1 := 51\n\tx2 := 56\n\ty  := 1\n\tdrawop im8 im5\n\ti := imagefalse\n\tv6 := 140\n\tv7 := 120\n\tv7 -= v6\n\tif v7 == 236 then i := imageok\n\tsprite x2 y 4\n\n\t#test \"8xy6\"\n\t# Note by Timendus: This should be 8XYE, changed the label here too.\n\t# See PR: https://github.com/corax89/chip8-test-rom/pull/7\n\ty := 6\n\tdrawop im8 imE\n\ti := imagefalse\n\tv6 := 224\n\tv6 <<= v6\n\tif v6 == 192 then i := imageok\n\tsprite x2 y 4\n\n\t#test \"8xyE\"\n\t# Note by Timendus: This should be 8XY6, changed the label here too.\n\t# See PR: https://github.com/corax89/chip8-test-rom/pull/7\n\ty := 11\n\tdrawop im8 im6\n\ti := imagefalse\n\tv6 := 15\n\tv6 >>= v6\n\tif v6 == 7 then i := imageok\n\tsprite x2 y 4\n\n\t#test Fx55,Fx65\n\ty := 16\n\tdrawop imF im5\n\ti := scratchpad\n\tv0 := 0\n\tv1 := 48\n\tsave v1\n\ti := scratchpad-plus-1\n\tload v0\n\ti := imagefalse\n\tif v0 == 48 then i := imageok\n\tsprite x2 y 4\n\n\t#test Fx33\n\ty := 21\n\tdrawop imF im3\n\ti := scratchpad\n\tv6 := 137\n\tbcd v6\n\tload v2\n\ti := imageok\n\tif v0 != 1 then i := imagefalse\n\tif v1 != 3 then i := imagefalse\n\tif v2 != 7 then i := imagefalse\n\tsprite x2 y 4\n\n\t#test 1x\n\ty := 26\n\tdrawop im1 imX\n\tjump test1x\n\n# Image data is in text-rendering.8o, as part of the font\n\n# Flags test\n\n# This is a visual adaptation of the math tests I wrote for Silicon8\n# (https://github.com/Timendus/silicon8/tree/main/tests)\n\n:macro opcode OPC {\n  vD := OPC\n  flags-draw-opcode\n}\n\n:macro expect REG VAL {\n  i := flag-err\n  if REG == VAL then i := flag-ok\n  y += 1\n  sprite x y 3\n}\n\n:macro expect-val-flag VAL FLAG {\n  vE := vF\n  vD := FLAG\n  vC := VAL\n  flags-draw-results\n}\n\n: flags-test-after-keyrelease\n\twaitKeyRelease\n: flags-test\n\tclear\n\n\t## Without complications\n\n\ttext 1 1 flags-no-carry\n\tx := 23\n\ty := 1\n\n\tv0 := 50\n\tv1 := 15\n\n\t# OR\n\topcode 0x81\n\tv2 := v0\n\tv2 |= v1 # 63 (0x3F)\n\texpect-val-flag 63 0\n\n\t# AND\n\topcode 0x82\n\tv2 := v0\n\tv2 &= v1 # 2 (0x02)\n\texpect-val-flag 2 0\n\n\t# XOR\n\topcode 0x83\n\tv2 := v0\n\tv2 ^= v1 # 61 (0x3D)\n\texpect-val-flag 61 0\n\n\t# Addition (no overflow)\n\topcode 0x84\n\tv2 := v0\n\tv2 += v1 # 65 (0x41)\n\texpect-val-flag 65 0\n\n\t# Subtraction in one direction (no carry)\n\topcode 0x85\n\tv2 := v0\n\tv2 -= v1 # 35 (0x23)\n\texpect-val-flag 35 1\n\n\t# Shift right (no LSB)\n\topcode 0x86\n\tv2 := v0\n\tv2 >>= v2 # 25 (0x19)\n\texpect-val-flag 25 0\n\n\t# Subtraction in the other direction (no carry)\n\topcode 0x87\n\tv2 := v1\n\tv2 =- v0 # 35 (0x23)\n\texpect-val-flag 35 1\n\n\t# Shift left (no MSB)\n\topcode 0x8E\n\tv2 := v0\n\tv2 <<= v2 # 100 (0x64)\n\texpect-val-flag 100 0\n\n\n\t# With complications\n\n\ttext 1 17 flags-carry\n\tx := 23\n\ty := 17\n\n\tv0 := 200\n\tv1 := 100\n\n\t# Addition (with overflow)\n\topcode 0x84\n\tv2 := v0\n\tv2 += v1 # 300 (0x2C)\n\texpect-val-flag 0x2C 1\n\n\t# Subtraction in one direction (with carry)\n\topcode 0x85\n\tv2 := v1\n\tv2 -= v0 # 100 - 200 = -100 = 156 (0x9C)\n\texpect-val-flag 0x9C 0\n\n\t# Shift right (with LSB)\n\topcode 0x86\n\tv2 := 3\n\tv2 >>= v2 # 1 (0x1)\n\texpect-val-flag 1 1\n\n\t# Subtraction in the other direction (with carry)\n\topcode 0x87\n\tv2 := v0\n\tv2 =- v1 # 100 - 200 = -100 = 156 (0x9C)\n\texpect-val-flag 0x9C 0\n\n\t# Shift left (with MSB)\n\topcode 0x8E\n\tv2 := v0\n\tv2 <<= v2 # 400 (0x90)\n\texpect-val-flag 0x90 1\n\n\t# Addition to i\n\n\ttext 1 28 flags-other\n\tx := 23\n\ty := 28\n\n\topcode 0xFE\n\ti := scratchpad\n\tv1 := 0x10\n\ti += v1\n\tv0 := 0xAA\n\tsave v0\n\ti := scratchpad-plus-16\n\tload v0\n\texpect v0 0xAA\n\n\tjump menu-after-keypress\n\n: flags-draw-opcode\n\ti := im0\n\tvE := vD\n\tvF := 0xF0\n\tvE &= vF\n\tvE >>= vE\n\tvE >>= vE\n\ti += vE\n\tsprite x y 4\n\tx += 4\n\ti := im0\n\tvE := vD\n\tvF := 0x0F\n\tvE &= vF\n\tvE <<= vE\n\tvE <<= vE\n\ti += vE\n\tsprite x y 4\n\tx += 6\n\treturn\n\n: flags-draw-results\n\ti := flag-err\n\tif v2 == vC then i := flag-ok\n\ty += 1\n\tsprite x y 3\n\tx += 5\n\ti := flag-err\n\tif vE == vD then i := flag-ok\n\tsprite x y 3\n\tx += 7\n\ty -= 1\n\tif x == 67 begin\n\t\ty += 5\n\t\tx := 1\n\tend\n\treturn\n\n\n# Quirks test\n\n# This is a visual adaptation of some of the tests I wrote for Silicon8\n# (https://github.com/Timendus/silicon8/tree/main/tests) and some newly written\n# tests for specific quirks.\n\n: quirks-test-after-keyrelease\n\twaitKeyRelease\n: quirks-test\n\tclear\n\ti := 0x1FE\n\tload v0\n\tif v0 == 1 then jump quirks-chip8\n\tif v0 == 2 then jump quirks-schip\n\tif v0 == 3 then jump quirks-xochip\n\n\ttext  6  3 quirks-choose\n\ttext 16 12 quirks-str-chip8\n\ttext 16 17 quirks-str-schip\n\ttext 16 22 quirks-str-xochip\n\n\tv1 := 12\n\tv2 := 13\n\tv3 := 0\n\ti := menu-cursor\n\tdelay := v3\n\tloop\n\t\t# Blink cursor\n\t\tv0 := delay\n\t\tif v0 == 0 begin\n\t\t\tsprite v1 v2 2\n\t\t\tv0 := 10\n\t\t\tdelay := v0\n\t\t\tv0 := 1\n\t\t\tv3 ^= v0\n\t\tend\n\n\t\t# Use numbers to start test\n\t\tv0 := 1   if v0 key then jump quirks-chip8\n\t\tv0 := 2   if v0 key then jump quirks-schip\n\t\tv0 := 3   if v0 key then jump quirks-xochip\n\n\t\t# Select test under cursor\n\t\tv0 := 6\n\t\tif v0 key begin\n\t\t\tif v2 == 13 then jump quirks-chip8\n\t\t\tif v2 == 18 then jump quirks-schip\n\t\t\tif v2 == 23 then jump quirks-xochip\n\t\tend\n\n\t\t# Move cursor\n\t\t# Up\n\t\tv0 := 5\n\t\tif v0 key begin\n\t\t\tif v3 == 1 then sprite v1 v2 2\n\t\t\tif v2 > 13 then v2 -= 5\n\t\t\tif v3 == 1 then sprite v1 v2 2\n\t\t\twaitKeyRelease\n\t\tend\n\t\t# Down\n\t\tv0 := 8\n\t\tif v0 key begin\n\t\t\tif v3 == 1 then sprite v1 v2 2\n\t\t\tif v2 < 23 then v2 += 5\n\t\t\tif v3 == 1 then sprite v1 v2 2\n\t\t\twaitKeyRelease\n\t\tend\n\tagain\n\n: quirks-chip8\n\ti := scratchpad\n\tv0 := 1\n\tsave v0\n\tjump quirks-run-tests\n\n: quirks-schip\n\ti := scratchpad\n\tv0 := 2\n\tsave v0\n\tjump quirks-run-tests\n\n: quirks-xochip\n\ti := scratchpad\n\tv0 := 3\n\tsave v0\n\n: quirks-run-tests\n\twaitKeyRelease\n\n\t# Determine frames per second\n\tv0 := 120\n\tdelay := v0\n\ti := quirks-values\n\tload vA\n\ti := quirks-image\n\tloop\n\t\tclear\n\t\tsprite v0 v0 8\n\t\tsprite v1 v0 8\n\t\tsprite v2 v0 8\n\t\tsprite v3 v0 8\n\t\tsprite v4 v0 8\n\t\tsprite v5 v0 8\n\t\tsprite v6 v0 8\n\t\tsprite v7 v0 8\n\t\tsprite v0 v1 8\n\t\tsprite v1 v1 8\n\t\tsprite v2 v1 8\n\t\tsprite v3 v1 8\n\t\tsprite v4 v1 8\n\t\tsprite v5 v1 8\n\t\tsprite v6 v1 8\n\t\tsprite v7 v1 8\n\t\tsprite v0 v2 8\n\t\tsprite v1 v2 8\n\t\tsprite v2 v2 8\n\t\tsprite v3 v2 8\n\t\tsprite v4 v2 8\n\t\tsprite v5 v2 8\n\t\tsprite v6 v2 8\n\t\tsprite v7 v2 8\n\t\tsprite v0 v3 8\n\t\tsprite v1 v3 8\n\t\tsprite v2 v3 8\n\t\tsprite v3 v3 8\n\t\tsprite v4 v3 8\n\t\tsprite v5 v3 8\n\t\tsprite v6 v3 8\n\t\tsprite v7 v3 8\n\t\tv8 += vA\n\t\tv9 += vF\n\t\tvE := delay\n\tif vE != 0 then again\n\n\tvE := 128\n\tv8 >>= v8\n\tv9 >>= v9\n\tif vF == 1 then v8 |= vE\n\n\tv0 := 1\n\tif v9 != 0 then v0 := 0\n\tif v8 != 2 then v0 := 0\n\ti := scratchpad-plus-1\n\tsave v0\n\n\t# Determine if sprites get clipped\n\tclear\n\ti := keypad-cursor\n\tv0 := 28\n\tv1 := 29\n\tsprite v0 v1 6\n\tv0 := 22\n\tv1 := 2\n\tsprite v0 v1 1\n\tv5 := vF\n\tv0 := 34\n\tsprite v0 v1 1\n\tv6 := vF\n\tv0 := 0\n\tif v5 == 0 then v0 := 1\n\tif v5 != v6 then v0 := 2\n\ti := scratchpad-plus-2\n\tsave v0\n\n\t# Present results\n\n\tclear\n\n\t# vfQuirk\n\t# When using &, | or ^, the flags register always gets reset to 0\n\ttext 1 1 quirks-vf\n\tv5 := 0\n\tvF := 15\n\tv0 &= v0\n\tif vF == 0 then v5 := 1\n\tv6 := 0\n\tvF := 15\n\tv0 |= v0\n\tif vF == 0 then v6 := 1\n\tv7 := 0\n\tvF := 15\n\tv0 ^= v0\n\tif vF == 0 then v7 := 1\n\ti := scratchpad\n\tload v0\n\ti := flag-err\n\tif v0 == 1 begin\n\t\t# Selected CHIP-8\n\t\tif v5 == 1 then i := flag-ok\n\telse\n\t\t# Selected SCHIP or XO-CHIP\n\t\tif v5 == 0 then i := flag-ok\n\tend\n\tx := 59\n\ty := 2\n\tsprite x y 3\n\ti := quirks-off\n\tif v5 == 1 then i := quirks-on\n\tif v5 != v6 then i := quirks-inconsistent\n\tif v5 != v7 then i := quirks-inconsistent\n\tvD := 44\n\tvE := 1\n\tdrawText\n\n\t# memQuirk\n\t# When reading or writing memory, i gets incremented\n\ttext 1 6 quirks-mem\n\tv0 := 5\n\ti := scratchpad-plus-16\n\tsave v0\n\tload v0\n\tv5 := v0\n\ti := scratchpad\n\tload v0\n\ti := flag-err\n\tif v0 == 2 begin\n\t\t# Selected SCHIP\n\t\tif v5 == 5 then i := flag-ok\n\telse\n\t\t# Selected CHIP-8 or XO-CHIP\n\t\tif v5 != 5 then i := flag-ok\n\tend\n\tx := 59\n\ty := 7\n\tsprite x y 3\n\ti := quirks-on\n\tif v5 == 5 then i := quirks-off\n\tvD := 44\n\tvE := 6\n\tdrawText\n\n\t# dispQuirk\n\t# When drawing a sprite to the screen, the interpreter waits for v-blank\n\ttext 1 11 quirks-disp\n\ti := scratchpad\n\tload v1\n\ti := flag-err\n\tif v0 == 1 begin\n\t\t# Selected CHIP-8\n\t\tif v1 == 1 then i := flag-ok\n\telse\n\t\t# Selected SCHIP or XO-CHIP\n\t\tif v1 == 0 then i := flag-ok\n\tend\n\tx := 59\n\ty := 12\n\tsprite x y 3\n\ti := quirks-off\n\tif v1 == 1 then i := quirks-on\n\tvD := 44\n\tvE := 11\n\tdrawText\n\n\t# clipQuirk\n\t# Sprites wrap to the top of the screen\n\ttext 1 16 quirks-clip\n\ti := scratchpad\n\tload v2\n\ti := flag-err\n\tif v0 == 3 begin\n\t\t# Selected XO-CHIP\n\t\tif v2 == 0 then i := flag-ok\n\telse\n\t\t# Selected CHIP-8 or SCHIP\n\t\tif v2 == 1 then i := flag-ok\n\tend\n\tx := 59\n\ty := 17\n\tsprite x y 3\n\ti := quirks-off\n\tif v2 == 1 then i := quirks-on\n\tif v2 == 2 then i := quirks-inconsistent\n\tvD := 44\n\tvE := 16\n\tdrawText\n\n\t# shiftQuirk\n\t# When shifting a register, the interpreter always shifts register X into\n\t# register X (instead of shifting register Y into register X)\n\ttext 1 21 quirks-shift\n\tv5 := 0\n\tv6 := 8\n\tv7 := 0\n\tv8 := 32\n\tv5 <<= v6\n\tv7 >>= v8\n\ti := scratchpad\n\tload v0\n\ti := flag-err\n\tif v0 == 2 begin\n\t\t# Selected SCHIP\n\t\tif v5 == 0 then i := flag-ok\n\telse\n\t\t# Selected CHIP-8 or XO-CHIP\n\t\tif v5 != 0 then i := flag-ok\n\tend\n\tx := 59\n\ty := 22\n\tsprite x y 3\n\ti := quirks-off\n\tif v5 == 0 then i := quirks-on\n\tif v5 != v7 then i := quirks-inconsistent\n\tvD := 44\n\tvE := 21\n\tdrawText\n\n\t# jumpQuirk\n\t# When using `jump0` (BNNN) the interpreter doesn't jump to NNN + v0 but to\n\t# NNN + vX where X is the highest nibble of NNN\n\ttext 1 26 quirks-jump\n\tv0 := 0x10\n\tvE := 0x20\n\tjump0 0xE00      # This jumps to one of two routines defined in index.8o (for\n: quirks-resume    # reasons of having to put them in precisely the right spot)\n\ti := scratchpad\n\tload v0\n\ti := flag-err\n\tif v0 == 2 begin\n\t\t# Selected SCHIP\n\t\tif v5 != 0 then i := flag-ok\n\telse\n\t\t# Selected CHIP-8 or XO-CHIP\n\t\tif v5 == 0 then i := flag-ok\n\tend\n\tx := 59\n\ty := 27\n\tsprite x y 3\n\ti := quirks-off\n\tif v5 == 1 then i := quirks-on\n\tvD := 44\n\tvE := 26\n\tdrawText\n\n\tjump menu-after-keypress\n\n\n# Keypad test\n# A fresh new implementation for this test suite\n\n: keypad-test\n\tclear\n\ti := keypad-initial-values\n\tload vF\n\ti := scratchpad\n\tsave vF\n\ttext 18 3 keypad-row1\n\ttext 18 10 keypad-row2\n\ttext 18 17 keypad-row3\n\ttext 18 24 keypad-row4\n\tvE := 0\n\tloop\n\t\tkeypad-pressed\n\t\tvE += 1\n\t\tif vE == 16 then vE := 0\n\tagain\n\n: keypad-pressed\n\ti := scratchpad\n\ti += vE\n\tload v0\n\tv2 := 0\n\tif vE key then v2 := 1\n\tif v0 != v2 begin\n\t\tv0 := vE\n\t\tv0 <<= v0\n\t\ti := keypad-coordinates\n\t\ti += v0\n\t\tload v1\n\t\ti := keypad-cursor\n\t\tsprite v0 v1 6\n\t\ti := scratchpad\n\t\ti += vE\n\t\tv0 := v2\n\t\tsave v0\n\tend\n\treturn\n\n\n\n\n: logo-part1\n  0x0f 0x02 0x02 0x02 0x02 0x02 0x00 0x00 0x1f 0x3f 0x71 0xe0 0xe5 0xe0 0xe8\n: logo-part2\n  0xa0 0x0d 0x2a 0x28 0x28 0x28 0x00 0x00 0x18 0xb8 0xb8 0x38 0x38 0x3f 0xbf\n: logo-part3\n  0x00 0x19 0xa5 0xbd 0xa1 0x9d 0x00 0x00 0x0c 0x1d 0x1d 0x01 0x0d 0x1d 0x9d\n: logo-part4\n  0x01 0xc7 0x29 0x29 0x29 0x27 0x00 0x00 0xf8 0xfc 0xce 0xc6 0xc6 0xc6 0xc6\n: logo-part5\n  0x00 0x49 0x4a 0x49 0x48 0x3b 0x00 0x00 0x00 0x01 0x03 0x03 0x03 0x01 0xf0\n: logo-part6\n  0x30 0x90 0x00 0x00 0x80 0x00 0x00 0x00 0xfe 0xc7 0x83 0x83 0x83 0xc6 0xfc\n: logo-part7\n  0xe7 0xe0 0xe0 0xe0 0xe0 0x71 0x3f 0x1f 0x00 0x00 0x07 0x02 0x02 0x02 0x02\n: logo-part8\n  0x39 0x38 0x38 0x38 0x38 0xb8 0xb8 0x38 0x00 0x00 0x31 0x4a 0x79 0x40 0x3b\n: logo-part9\n  0xdd 0xdd 0xdd 0xdd 0xdd 0xdd 0xdd 0xdd 0x00 0x00 0xa0 0x38 0x20 0xa0 0x18\n: logo-part10\n  0xce 0xfc 0xf8 0xc0 0xc0 0xca 0xca 0xc4 0x00 0x00 0x30 0x44 0x24 0x14 0x63\n: logo-part11\n  0xf1 0x03 0x07 0x47 0xc7 0x47 0x43 0xe1 0x00 0x00 0x28 0x8e 0xa8 0xa8 0xa6\n: logo-part12\n  0xce 0x87 0x03 0x03 0x03 0x87 0xfe 0xfc 0x00 0x00 0x60 0x90 0xf0 0x80 0x70\n\n: scratchpad\n\t0\n: scratchpad-plus-1\n\t0\n: scratchpad-plus-2\n\t0 0 0 0 0\n\t0 0 0 0 0\n\t0 0 0 0\n: scratchpad-plus-16\n  0\n\n: menu-header\n\tstr \"PICK A TEST\" 0\n: menu-ibm\n\tstr \"1 IBM LOGO\" 0\n: menu-corax\n\tstr \"2 CORAX89\" 0\n: menu-flags\n\tstr \"3 FLAGS\" 0\n: menu-quirks\n\tstr \"4 QUIRKS\" 0\n: menu-keypad\n\tstr \"5 KEYPAD\" 0\n\n: menu-cursor\n\t0b11000000\n\t0b11000000\n\n# Positive and negative images\n: imageok\n\t0xEA 0xAC 0xAA 0xEA\n: imagefalse\n\t0xCE 0xAA 0xAA 0xAE\n\n: flag-ok\n\t0b10100000\n\t0b11000000\n\t0b10000000\n: flag-err\n\t0b10100000\n\t0b01000000\n\t0b10100000\n\n# Individual characters, some taken from Corax89' test.\n: characters\n\t0 0 0 0\n: im0\n\t0xE0 0xA0 0xA0 0xE0\n: im1\n\t0xC0 0x40 0x40 0xE0\n: im2\n\t0xE0 0x20 0xC0 0xE0\n: im3\n\t0xE0 0x60 0x20 0xE0\n: im4\n\t0xA0 0xE0 0x20 0x20\n: im5\n\t0b11100000\n\t0b11000000\n\t0b00100000\n\t0b11000000\n: im6\n\t0xE0 0x80 0xE0 0xE0\n: im7\n\t0xE0 0x20 0x20 0x20\n: im8\n\t0xE0 0xE0 0xA0 0xE0\n: im9\n\t0xE0 0xE0 0x20 0xE0\n: imA\n\t0x40 0xA0 0xE0 0xA0\n: imB\n\t0b11000000\n\t0b11100000\n\t0b10100000\n\t0b11100000\n: imC\n\t0b11100000\n\t0b10000000\n\t0b10000000\n\t0b11100000\n: imD\n\t0b11000000\n\t0b10100000\n\t0b10100000\n\t0b11000000\n: imE\n\t0xE0 0xC0 0x80 0xE0\n: imF\n\t0xE0 0x80 0xC0 0x80\n: imG\n\t0b01100000\n\t0b10000000\n\t0b10100000\n\t0b01100000\n: imH\n\t0b10100000\n\t0b11100000\n\t0b10100000\n\t0b10100000\n: imI\n\t0b11100000\n\t0b01000000\n\t0b01000000\n\t0b11100000\n: imJ\n\t0b01100000\n\t0b00100000\n\t0b00100000\n\t0b11000000\n: imK\n\t0b10100000\n\t0b11000000\n\t0b10100000\n\t0b10100000\n: imL\n\t0b10000000\n\t0b10000000\n\t0b10000000\n\t0b11100000\n: imM\n\t0b11100000\n\t0b11100000\n\t0b10100000\n\t0b10100000\n: imN\n\t0b11000000\n\t0b10100000\n\t0b10100000\n\t0b10100000\n: imO\n\t0b11100000\n\t0b10100000\n\t0b10100000\n\t0b11100000\n: imP\n\t0b11000000\n\t0b10100000\n\t0b11000000\n\t0b10000000\n: imQ\n\t0b01000000\n\t0b10100000\n\t0b11100000\n\t0b01100000\n: imR\n\t0b11000000\n\t0b10100000\n\t0b11000000\n\t0b10100000\n: imS\n\t0b01100000\n\t0b11000000\n\t0b00100000\n\t0b11000000\n: imT\n\t0b11100000\n\t0b01000000\n\t0b01000000\n\t0b01000000\n: imU\n\t0b10100000\n\t0b10100000\n\t0b10100000\n\t0b01100000\n: imV\n\t0b10100000\n\t0b10100000\n\t0b10100000\n\t0b01000000\n: imW\n\t0b10100000\n\t0b10100000\n\t0b11100000\n\t0b11100000\n: imX\n\t0xA0 0x40 0xA0 0xA0\n: imY\n\t0b10100000\n\t0b10100000\n\t0b01000000\n\t0b01000000\n: imZ\n\t0b11100000\n\t0b01100000\n\t0b10000000\n\t0b11100000\n: imSpace\n\t0 0 0 0\n: imDash\n\t0b00000000\n\t0b11100000\n\t0b00000000\n\t0b00000000\n: imPeriod\n\t0b00000000\n\t0b00000000\n\t0b00000000\n\t0b01000000\n\n: ibm-logo-part1\n  0xFF 0x00 0xFF 0x00 0x3C 0x00 0x3C 0x00 0x3C 0x00 0x3C 0x00 0xFF 0x00 0xFF\n: ibm-logo-part2\n  0xFF 0x00 0xFF 0x00 0x38 0x00 0x3F 0x00 0x3F 0x00 0x38 0x00 0xFF 0x00 0xFF\n: ibm-logo-part3\n  0x80 0x00 0xE0 0x00 0xE0 0x00 0x80 0x00 0x80 0x00 0xE0 0x00 0xE0 0x00 0x80\n: ibm-logo-part4\n  0xF8 0x00 0xFC 0x00 0x3E 0x00 0x3F 0x00 0x3B 0x00 0x39 0x00 0xF8 0x00 0xF8\n: ibm-logo-part5\n  0x03 0x00 0x07 0x00 0x0F 0x00 0xBF 0x00 0xFB 0x00 0xF3 0x00 0xE3 0x00 0x43\n: ibm-logo-part6\n  0xE0 0x00 0xE0 0x00 0x80 0x00 0x80 0x00 0x80 0x00 0x80 0x00 0xE0 0x00 0xE0\n\n: flags-no-carry\n\tstr \"NO C.\" 0\n: flags-carry\n\tstr \"CARRY\" 0\n: flags-other\n\tstr \"OTHER\" 0\n\n: quirks-choose\n\tstr \"PICK PLATFORM\" 0\n: quirks-str-chip8\n\tstr \"1 CHIP-8\" 0\n: quirks-str-schip\n\tstr \"2 SCHIP\" 0\n: quirks-str-xochip\n\tstr \"3 XO-CHIP\" 0\n\n: quirks-vf\n\tstr \"VF RESET\" 0\n: quirks-mem\n\tstr \"MEMORY\" 0\n: quirks-disp\n\tstr \"DISP.WAIT\" 0\n: quirks-clip\n\tstr \"CLIPPING\" 0\n: quirks-shift\n\tstr \"SHIFTING\" 0\n: quirks-jump\n\tstr \"JUMPING\" 0\n\n: quirks-on\n\tstr \"ON\" 0\n: quirks-off\n\tstr \"OFF\" 0\n: quirks-inconsistent\n\tstr \"ERR\" 0\n\n: quirks-values\n\t0 8 16 24 32 40 48 56 0 0 1\n: quirks-image\n\t0x3C 0x7E 0xFF 0xDB 0xFF 0xDB 0x66 0x3C\n\n: keypad-initial-values\n\t0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0\n\n: keypad-row1\n\tstr \"1 2 3 C\" 0\n: keypad-row2\n\tstr \"4 5 6 D\" 0\n: keypad-row3\n\tstr \"7 8 9 E\" 0\n: keypad-row4\n\tstr \"A 0 B F\" 0\n\n: keypad-coordinates\n\t24 23 # 0\n\t16 2  # 1\n\t24 2  # 2\n\t32 2  # 3\n\t16 9  # 4\n\t24 9  # 5\n\t32 9  # 6\n\t16 16 # 7\n\t24 16 # 8\n\t32 16 # 9\n\t16 23 # A\n\t32 23 # B\n\t40 2  # C\n\t40 9  # D\n\t40 16 # E\n\t40 23 # F\n\n: keypad-cursor\n\t0b11111110\n\t0b11111110\n\t0b11111110\n\t0b11111110\n\t0b11111110\n\t0b11111110\n\n# Jump quirk targets:\n:org 0xE10\n\t# We jump here when using v0 in the `jump0` quirks test\n\tv5 := 0\n\tjump quirks-resume\n:org 0xE20\n\t# We jump here when using vE in the `jump0` quirks test\n\tv5 := 1\n\tjump quirks-resume","options":{"tickrate":20,"fillColor":"#FFCC00","fillColor2":"#FF6600","blendColor":"#662200","backgroundColor":"#996600","buzzColor":"#FFAA00","quietColor":"#000000","shiftQuirks":false,"loadStoreQuirks":false,"vfOrderQuirks":false,"clipQuirks":true,"jumpQuirks":false,"logicQuirks":true,"vBlankQuirks":true,"screenRotation":0,"maxSize":3216,"touchInputMode":"none","fontStyle":"octo","displayScale":"6"},"rom":[0,224,97,1,96,8,170,24,208,31,96,16,170,39,208,31,96,24,170,54,208,31,96,32,170,69,208,31,96,40,170,84,208,31,96,48,170,99,208,31,97,16,96,8,170,114,208,31,96,16,170,129,208,31,96,24,170,144,208,31,96,32,170,159,208,31,96,40,170,174,208,31,96,48,170,189,208,31,18,80,161,255,240,101,64,1,19,218,64,2,20,18,64,3,21,164,64,4,23,10,64,5,25,186,64,9,18,128,18,124,96,0,224,161,18,112,112,1,64,16,0,238,18,112,240,10,34,110,0,224,109,10,110,1,170,221,35,56,109,14,110,7,170,233,35,56,109,14,110,12,170,244,35,56,109,14,110,17,170,254,35,56,109,14,110,22,171,6,35,56,109,14,110,27,171,15,35,56,97,10,98,8,99,0,171,24,243,21,240,7,48,0,18,204,209,34,96,10,240,21,96,1,131,3,96,1,224,161,19,216,96,2,224,161,20,16,96,3,224,161,21,162,96,4,224,161,23,8,96,12,224,161,23,8,96,6,224,158,19,6,34,110,66,8,19,218,66,13,20,18,66,18,21,164,66,23,23,10,66,28,25,186,96,5,224,158,19,30,67,1,209,34,111,8,143,37,79,0,114,251,67,1,209,34,34,110,96,8,224,158,19,54,67,1,209,34,111,28,143,39,79,0,114,5,67,1,209,34,34,110,18,188,252,101,64,0,0,238,171,40,240,30,221,228,125,4,65,0,0,238,171,40,241,30,221,228,125,4,66,0,0,238,171,40,242,30,221,228,125,4,67,0,0,238,171,40,243,30,221,228,125,4,68,0,0,238,171,40,244,30,221,228,125,4,69,0,0,238,171,40,245,30,221,228,125,4,70,0,0,238,171,40,246,30,221,228,125,4,71,0,0,238,171,40,247,30,221,228,125,4,72,0,0,238,171,40,248,30,221,228,125,4,73,0,0,238,171,40,249,30,221,228,125,4,74,0,0,238,171,40,250,30,221,228,125,4,75,0,0,238,171,40,251,30,221,228,125,4,76,0,0,238,171,40,252,30,221,228,125,4,0,238,34,110,0,224,171,200,96,12,97,8,208,31,112,9,171,215,208,31,171,230,112,8,208,31,112,4,171,245,208,31,112,8,172,4,208,31,112,8,172,19,208,31,18,124,171,26,218,180,0,238,171,26,218,180,18,124,34,110,0,224,104,1,105,5,106,10,107,1,101,42,102,43,171,56,216,180,171,176,217,180,171,26,54,43,171,30,218,180,107,6,171,60,216,180,171,176,217,180,171,30,69,42,171,26,218,180,107,11,171,64,216,180,171,176,217,180,171,30,85,96,171,26,218,180,107,16,171,72,216,180,171,176,217,180,171,30,118,255,70,42,171,26,218,180,107,21,171,80,216,180,171,176,217,180,171,30,149,96,171,26,218,180,107,26,171,52,216,180,171,176,217,180,36,4,104,24,105,28,106,33,107,1,171,44,216,180,171,100,217,180,171,26,218,180,107,6,171,76,216,180,171,44,217,180,171,30,135,80,71,42,171,26,218,180,107,11,171,76,216,180,171,48,217,180,171,30,103,42,135,177,71,43,171,26,218,180,107,16,171,76,216,180,171,52,217,180,171,30,102,120,103,31,135,98,71,24,171,26,218,180,107,21,171,76,216,180,171,56,217,180,171,30,102,120,103,31,135,99,71,103,171,26,218,180,107,26,171,76,216,180,171,60,217,180,171,30,102,140,103,140,135,100,71,24,171,26,218,180,104,47,105,51,106,56,107,1,171,76,216,180,171,64,217,180,171,30,102,140,103,120,135,101,71,236,171,26,218,180,107,6,171,76,216,180,171,100,217,180,171,30,102,224,134,110,70,192,171,26,218,180,107,11,171,76,216,180,171,68,217,180,171,30,102,15,134,102,70,7,171,26,218,180,107,16,171,104,216,180,171,64,217,180,170,204,96,0,97,48,241,85,170,205,240,101,171,30,64,48,171,26,218,180,107,21,171,104,216,180,171,56,217,180,170,204,102,137,246,51,242,101,171,26,48,1,171,30,49,3,171,30,50,7,171,30,218,180,107,26,171,48,216,180,171,176,217,180,20,10,34,110,0,224,109,1,110,1,172,34,35,56,106,23,107,1,96,50,97,15,109,129,38,192,130,0,130,17,142,240,109,0,108,63,38,230,109,130,38,192,130,0,130,18,142,240,109,0,108,2,38,230,109,131,38,192,130,0,130,19,142,240,109,0,108,61,38,230,109,132,38,192,130,0,130,20,142,240,109,0,108,65,38,230,109,133,38,192,130,0,130,21,142,240,109,1,108,35,38,230,109,134,38,192,130,0,130,38,142,240,109,0,108,25,38,230,109,135,38,192,130,16,130,7,142,240,109,1,108,35,38,230,109,142,38,192,130,0,130,46,142,240,109,0,108,100,38,230,109,1,110,17,172,40,35,56,106,23,107,17,96,200,97,100,109,132,38,192,130,0,130,20,142,240,109,1,108,44,38,230,109,133,38,192,130,16,130,5,142,240,109,0,108,156,38,230,109,134,38,192,98,3,130,38,142,240,109,1,108,1,38,230,109,135,38,192,130,0,130,23,142,240,109,0,108,156,38,230,109,142,38,192,130,0,130,46,142,240,109,1,108,144,38,230,109,1,110,28,172,46,35,56,106,23,107,28,109,254,38,192,170,204,97,16,241,30,96,170,240,85,170,220,240,101,171,37,64,170,171,34,123,1,218,179,18,124,171,44,142,208,111,240,142,242,142,230,142,230,254,30,218,180,122,4,171,44,142,208,111,15,142,242,142,238,142,238,254,30,218,180,122,6,0,238,171,37,146,192,171,34,123,1,218,179,122,5,171,37,158,208,171,34,218,179,122,7,123,255,58,67,23,6,123,5,106,1,0,238,34,110,0,224,161,254,240,101,64,1,23,172,64,2,23,180,64,3,23,188,109,6,110,3,172,52,35,56,109,16,110,12,172,66,35,56,109,16,110,17,172,75,35,56,109,16,110,22,172,83,35,56,97,12,98,13,99,0,171,24,243,21,240,7,48,0,23,86,209,34,96,10,240,21,96,1,131,3,96,1,224,161,23,172,96,2,224,161,23,180,96,3,224,161,23,188,96,6,224,158,23,122,66,13,23,172,66,18,23,180,66,23,23,188,96,5,224,158,23,146,67,1,209,34,111,13,143,37,79,0,114,251,67,1,209,34,34,110,96,8,224,158,23,170,67,1,209,34,111,23,143,39,79,0,114,5,67,1,209,34,34,110,23,70,170,204,96,1,240,85,23,194,170,204,96,2,240,85,23,194,170,204,96,3,240,85,34,110,96,120,240,21,172,156,250,101,172,167,0,224,208,8,209,8,210,8,211,8,212,8,213,8,214,8,215,8,208,24,209,24,210,24,211,24,212,24,213,24,214,24,215,24,208,40,209,40,210,40,211,40,212,40,213,40,214,40,215,40,208,56,209,56,210,56,211,56,212,56,213,56,214,56,215,56,136,164,137,244,254,7,62,0,23,206,110,128,136,134,137,150,79,1,136,225,96,1,57,0,96,0,56,2,96,0,170,205,240,85,0,224,172,255,96,28,97,29,208,22,96,22,97,2,208,17,133,240,96,34,208,17,134,240,96,0,69,0,96,1,85,96,96,2,170,206,240,85,0,224,109,1,110,1,172,93,35,56,101,0,111,15,128,2,79,0,101,1,102,0,111,15,128,1,79,0,102,1,103,0,111,15,128,3,79,0,103,1,170,204,240,101,171,37,48,1,24,144,69,1,171,34,24,148,69,0,171,34,106,59,107,2,218,179,172,148,69,1,172,145,85,96,172,152,85,112,172,152,109,44,110,1,35,56,109,1,110,6,172,102,35,56,96,5,170,220,240,85,240,101,133,0,170,204,240,101,171,37,48,2,24,208,69,5,171,34,24,212,53,5,171,34,106,59,107,7,218,179,172,145,69,5,172,148,109,44,110,6,35,56,109,1,110,11,172,109,35,56,170,204,241,101,171,37,48,1,24,254,65,1,171,34,25,2,65,0,171,34,106,59,107,12,218,179,172,148,65,1,172,145,109,44,110,11,35,56,109,1,110,16,172,119,35,56,170,204,242,101,171,37,48,3,25,44,66,0,171,34,25,48,66,1,171,34,106,59,107,17,218,179,172,148,66,1,172,145,66,2,172,152,109,44,110,16,35,56,109,1,110,21,172,128,35,56,101,0,102,8,103,0,104,32,133,110,135,134,170,204,240,101,171,37,48,2,25,106,69,0,171,34,25,110,53,0,171,34,106,59,107,22,218,179,172,148,69,0,172,145,85,112,172,152,109,44,110,21,35,56,109,1,110,26,172,137,35,56,96,16,110,32,190,0,170,204,240,101,171,37,48,2,25,162,53,0,171,34,25,166,69,0,171,34,106,59,107,27,218,179,172,148,69,1,172,145,109,44,110,26,35,56,18,124,0,224,172,175,255,101,170,204,255,85,109,18,110,3,172,191,35,56,109,18,110,10,172,199,35,56,109,18,110,17,172,207,35,56,109,18,110,24,172,215,35,56,110,0,41,240,126,1,78,16,110,0,25,230,170,204,254,30,240,101,98,0,238,161,98,1,144,32,26,22,128,224,128,14,172,223,240,30,241,101,172,255,208,22,170,204,254,30,128,32,240,85,0,238,15,2,2,2,2,2,0,0,31,63,113,224,229,224,232,160,13,42,40,40,40,0,0,24,184,184,56,56,63,191,0,25,165,189,161,157,0,0,12,29,29,1,13,29,157,1,199,41,41,41,39,0,0,248,252,206,198,198,198,198,0,73,74,73,72,59,0,0,0,1,3,3,3,1,240,48,144,0,0,128,0,0,0,254,199,131,131,131,198,252,231,224,224,224,224,113,63,31,0,0,7,2,2,2,2,57,56,56,56,56,184,184,56,0,0,49,74,121,64,59,221,221,221,221,221,221,221,221,0,0,160,56,32,160,24,206,252,248,192,192,202,202,196,0,0,48,68,36,20,99,241,3,7,71,199,71,67,225,0,0,40,142,168,168,166,206,135,3,3,3,135,254,252,0,0,96,144,240,128,112,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,104,76,52,84,148,44,148,120,60,116,120,0,8,148,76,48,92,148,88,100,68,100,0,12,148,52,100,112,44,136,36,40,0,16,148,64,88,44,68,116,0,20,148,108,124,76,112,84,116,0,24,148,84,60,140,104,44,56,0,192,192,234,172,170,234,206,170,170,174,160,192,128,160,64,160,0,0,0,0,224,160,160,224,192,64,64,224,224,32,192,224,224,96,32,224,160,224,32,32,224,192,32,192,224,128,224,224,224,32,32,32,224,224,160,224,224,224,32,224,64,160,224,160,192,224,160,224,224,128,128,224,192,160,160,192,224,192,128,224,224,128,192,128,96,128,160,96,160,224,160,160,224,64,64,224,96,32,32,192,160,192,160,160,128,128,128,224,224,224,160,160,192,160,160,160,224,160,160,224,192,160,192,128,64,160,224,96,192,160,192,160,96,192,32,192,224,64,64,64,160,160,160,96,160,160,160,64,160,160,224,224,160,64,160,160,160,160,64,64,224,96,128,224,0,0,0,0,0,224,0,0,0,0,0,64,255,0,255,0,60,0,60,0,60,0,60,0,255,0,255,255,0,255,0,56,0,63,0,63,0,56,0,255,0,255,128,0,224,0,224,0,128,0,128,0,224,0,224,0,128,248,0,252,0,62,0,63,0,59,0,57,0,248,0,248,3,0,7,0,15,0,191,0,251,0,243,0,227,0,67,224,0,224,0,128,0,128,0,128,0,128,0,224,0,224,96,100,148,52,156,0,52,44,112,112,140,0,100,120,72,60,112,0,104,76,52,84,148,104,88,44,120,64,100,112,92,0,8,148,52,72,76,104,152,36,0,12,148,116,52,72,76,104,0,16,148,136,100,152,52,72,76,104,0,128,64,148,112,60,116,60,120,0,92,60,92,100,112,140,0,56,76,116,104,156,132,44,76,120,0,52,88,76,104,104,76,96,68,0,116,72,76,64,120,76,96,68,0,80,124,92,104,76,96,68,0,100,96,0,100,64,64,0,60,112,112,0,0,8,16,24,32,40,48,56,0,0,1,60,126,255,219,255,219,102,60,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,148,12,148,16,148,52,0,20,148,24,148,28,148,56,0,32,148,36,148,40,148,60,0,44,148,4,148,48,148,64,0,24,23,16,2,24,2,32,2,16,9,24,9,32,9,16,16,24,16,32,16,16,23,32,23,40,2,40,9,40,16,40,23,254,254,254,254,254,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,101,0,25,146,0,0,0,0,0,0,0,0,0,0,0,0,101,1,25,146]}</script>
<script>"use strict";

function invertKeymap(k) {
	return Object.keys(k).reduce((a,b) => {
		Object.keys(k[b]).forEach(x => a[x]=+b)
		return a
	}, {})
}

function getPref(key) {
	try { return JSON.parse(localStorage.getItem(key)) }
	catch(e) { console.log(e); return null }
}
function setPref(key, value) {
	try { localStorage.setItem(key, JSON.stringify(value)) }
	catch(e) { console.log(e); }
}

var keymap = (this.STATIC_KEYMAP) || getPref('octoKeymap') || {
	0x0: { x:1 },
	0x1: { 1:1 },
	0x2: { 2:1 },
	0x3: { 3:1 },
	0x4: { q:1 },
	0x5: { w:1, ArrowUp:1 },
	0x6: { e:1, ' ':1 },
	0x7: { a:1, ArrowLeft:1 },
	0x8: { s:1, ArrowDown:1 },
	0x9: { d:1, ArrowRight:1 },
	0xA: { z:1 },
	0xB: { c:1 },
	0xC: { 4:1 },
	0xD: { r:1 },
	0xE: { f:1 },
	0xF: { v:1 },
}

var keymapInverse = invertKeymap(keymap)

var smallfonts = {
	octo: [
		0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
		0x20, 0x60, 0x20, 0x20, 0x70, // 1
		0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
		0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
		0x90, 0x90, 0xF0, 0x10, 0x10, // 4
		0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
		0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
		0xF0, 0x10, 0x20, 0x40, 0x40, // 7
		0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
		0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
		0xF0, 0x90, 0xF0, 0x90, 0x90, // A
		0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
		0xF0, 0x80, 0x80, 0x80, 0xF0, // C
		0xE0, 0x90, 0x90, 0x90, 0xE0, // D
		0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
		0xF0, 0x80, 0xF0, 0x80, 0x80, // F
	],
	vip: [
		0xF0, 0x90, 0x90, 0x90, 0xF0,
		0x60, 0x20, 0x20, 0x20, 0x70,
		0xF0, 0x10, 0xF0, 0x80, 0xF0,
		0xF0, 0x10, 0xF0, 0x10, 0xF0,
		0xA0, 0xA0, 0xF0, 0x20, 0x20,
		0xF0, 0x80, 0xF0, 0x10, 0xF0,
		0xF0, 0x80, 0xF0, 0x90, 0xF0,
		0xF0, 0x10, 0x10, 0x10, 0x10,
		0xF0, 0x90, 0xF0, 0x90, 0xF0,
		0xF0, 0x90, 0xF0, 0x10, 0xF0,
		0xF0, 0x90, 0xF0, 0x90, 0x90,
		0xF0, 0x50, 0x70, 0x50, 0xF0,
		0xF0, 0x80, 0x80, 0x80, 0xF0,
		0xF0, 0x50, 0x50, 0x50, 0xF0,
		0xF0, 0x80, 0xF0, 0x80, 0xF0,
		0xF0, 0x80, 0xF0, 0x80, 0x80,
	],
	dream6800: [
		0xE0, 0xA0, 0xA0, 0xA0, 0xE0,
		0x40, 0x40, 0x40, 0x40, 0x40,
		0xE0, 0x20, 0xE0, 0x80, 0xE0,
		0xE0, 0x20, 0xE0, 0x20, 0xE0,
		0x80, 0xA0, 0xA0, 0xE0, 0x20,
		0xE0, 0x80, 0xE0, 0x20, 0xE0,
		0xE0, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0xA0, 0xE0, 0xA0, 0xE0,
		0xE0, 0xA0, 0xE0, 0x20, 0xE0,
		0xE0, 0xA0, 0xE0, 0xA0, 0xA0,
		0xC0, 0xA0, 0xE0, 0xA0, 0xC0,
		0xE0, 0x80, 0x80, 0x80, 0xE0,
		0xC0, 0xA0, 0xA0, 0xA0, 0xC0,
		0xE0, 0x80, 0xE0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
	eti660: [
		0xE0, 0xA0, 0xA0, 0xA0, 0xE0,
		0x20, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0x20, 0xE0, 0x80, 0xE0,
		0xE0, 0x20, 0xE0, 0x20, 0xE0,
		0xA0, 0xA0, 0xE0, 0x20, 0x20,
		0xE0, 0x80, 0xE0, 0x20, 0xE0,
		0xE0, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0xA0, 0xE0, 0xA0, 0xE0,
		0xE0, 0xA0, 0xE0, 0x20, 0xE0,
		0xE0, 0xA0, 0xE0, 0xA0, 0xA0,
		0x80, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x80, 0x80, 0x80, 0xE0,
		0x20, 0x20, 0xE0, 0xA0, 0xE0,
		0xE0, 0x80, 0xE0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
	fish: [
		0x60, 0xA0, 0xA0, 0xA0, 0xC0,
		0x40, 0xC0, 0x40, 0x40, 0xE0,
		0xC0, 0x20, 0x40, 0x80, 0xE0,
		0xC0, 0x20, 0x40, 0x20, 0xC0,
		0x20, 0xA0, 0xE0, 0x20, 0x20,
		0xE0, 0x80, 0xC0, 0x20, 0xC0,
		0x40, 0x80, 0xC0, 0xA0, 0x40,
		0xE0, 0x20, 0x60, 0x40, 0x40,
		0x40, 0xA0, 0x40, 0xA0, 0x40,
		0x40, 0xA0, 0x60, 0x20, 0x40,
		0x40, 0xA0, 0xE0, 0xA0, 0xA0,
		0xC0, 0xA0, 0xC0, 0xA0, 0xC0,
		0x60, 0x80, 0x80, 0x80, 0x60,
		0xC0, 0xA0, 0xA0, 0xA0, 0xC0,
		0xE0, 0x80, 0xC0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
}
var bigfonts = {
	octo: [
		0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, // 0
		0x18, 0x78, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0xFF, // 1
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // 2
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 3
		0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0x03, 0x03, // 4
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 5
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 6
		0xFF, 0xFF, 0x03, 0x03, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x18, // 7
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 8
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 9
		0x7E, 0xFF, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, // A
		0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, // B
		0x3C, 0xFF, 0xC3, 0xC0, 0xC0, 0xC0, 0xC0, 0xC3, 0xFF, 0x3C, // C
		0xFC, 0xFE, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFE, 0xFC, // D
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // E
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0  // F
	],
	schip: [
		0x3C, 0x7E, 0xE7, 0xC3, 0xC3, 0xC3, 0xC3, 0xE7, 0x7E, 0x3C,
		0x18, 0x38, 0x58, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C,
		0x3E, 0x7F, 0xC3, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFF, 0xFF,
		0x3C, 0x7E, 0xC3, 0x03, 0x0E, 0x0E, 0x03, 0xC3, 0x7E, 0x3C,
		0x06, 0x0E, 0x1E, 0x36, 0x66, 0xC6, 0xFF, 0xFF, 0x06, 0x06,
		0xFF, 0xFF, 0xC0, 0xC0, 0xFC, 0xFE, 0x03, 0xC3, 0x7E, 0x3C,
		0x3E, 0x7C, 0xE0, 0xC0, 0xFC, 0xFE, 0xC3, 0xC3, 0x7E, 0x3C,
		0xFF, 0xFF, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x60,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7E, 0x7E, 0xC3, 0xC3, 0x7E, 0x3C,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7F, 0x3F, 0x03, 0x03, 0x3E, 0x7C,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // no hex chars!
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	],
	fish: [
		0x7C, 0xC6, 0xCE, 0xDE, 0xD6, 0xF6, 0xE6, 0xC6, 0x7C, 0x00, // at most 7x9 pixels!
		0x10, 0x30, 0xF0, 0x30, 0x30, 0x30, 0x30, 0x30, 0xFC, 0x00,
		0x78, 0xCC, 0xCC, 0x0C, 0x18, 0x30, 0x60, 0xCC, 0xFC, 0x00,
		0x78, 0xCC, 0x0C, 0x0C, 0x38, 0x0C, 0x0C, 0xCC, 0x78, 0x00,
		0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x0C, 0x1E, 0x00,
		0xFC, 0xC0, 0xC0, 0xC0, 0xF8, 0x0C, 0x0C, 0xCC, 0x78, 0x00,
		0x38, 0x60, 0xC0, 0xC0, 0xF8, 0xCC, 0xCC, 0xCC, 0x78, 0x00,
		0xFE, 0xC6, 0xC6, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00,
		0x78, 0xCC, 0xCC, 0xEC, 0x78, 0xDC, 0xCC, 0xCC, 0x78, 0x00,
		0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x18, 0x18, 0x30, 0x70, 0x00,
		0x30, 0x78, 0xCC, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC, 0x00,
		0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x66, 0xFC, 0x00,
		0x3C, 0x66, 0xC6, 0xC0, 0xC0, 0xC0, 0xC6, 0x66, 0x3C, 0x00,
		0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00,
		0xFE, 0x62, 0x60, 0x64, 0x7C, 0x64, 0x60, 0x62, 0xFE, 0x00,
		0xFE, 0x66, 0x62, 0x64, 0x7C, 0x64, 0x60, 0x60, 0xF0, 0x00,
	],
	none: new Array(16*10).fill(0x00),
}
var fontsets = {
	octo     : { small: smallfonts.octo,      big: bigfonts.octo  },
	vip      : { small: smallfonts.vip,       big: bigfonts.none  },
	dream6800: { small: smallfonts.dream6800, big: bigfonts.none  },
	eti660   : { small: smallfonts.eti660,    big: bigfonts.none  },
	schip    : { small: smallfonts.octo,      big: bigfonts.schip },
	fish     : { small: smallfonts.fish,      big: bigfonts.fish  },
}

////////////////////////////////////
//
//   The Chip8 Interpreter:
//
////////////////////////////////////

function Emulator() {

	// persistent configuration settings
	this.tickrate           = 20;
	this.fillColor          = "#FFCC00";
	this.fillColor2         = "#FF6600";
	this.blendColor         = "#662200";
	this.backgroundColor    = "#996600";
	this.buzzColor          = "#FFAA00";
	this.quietColor         = "#000000";
	this.shiftQuirks        = false;
	this.loadStoreQuirks    = false;
	this.vfOrderQuirks      = false;
	this.clipQuirks         = false;
	this.jumpQuirks         = false;
	this.logicQuirks        = false;
	this.vBlankQuirks       = false;
	this.enableXO           = true;
	this.screenRotation     = 0;//must be 0, 90, 180, or 270
	this.maxSize            = 3584;
	this.touchInputMode     = 'none';
	this.maskFormatOverride = true;
	this.numericFormatStr   = "default";
	this.fontStyle          = 'octo';

	// interpreter state
	this.p  = [[],[]];  // pixels
	this.m  = [];       // memory (bytes)
	this.r  = [];       // return stack
	this.v  = [];       // registers
	this.pc = 0;        // program counter
	this.i  = 0;        // index register
	this.dt = 0;        // delay timer
	this.st = 0;        // sound timer
	this.pitch   = 64;  // audio pitch register
	this.pattern = [];  // audio pattern buffer
	this.hires = false; // are we in SuperChip high res mode?
	this.flags = [];    // semi-persistent hp48 flag vars
	this.plane = 1;     // graphics plane
	this.profile_data = {};

	// control/debug state
	this.keys = {};       // track keys which are pressed
	this.waiting = false; // are we waiting for a keypress?
	this.waitReg = -1;    // destination register of an awaited key
	this.halted = true;
	this.breakpoint = false;
	this.metadata = {};
	this.tickCounter = 0;
	this.linted = false;

	// external interface stubs
	this.exitVector  = function() {}                                                           // fired by 'exit'
	this.importFlags = function() { return [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]; } // load persistent flags
	this.exportFlags = function(flags) {}                                                      // save persistent flags
	this.buzzTimer   = function(timer) {}
	this.buzzBuffer  = function(buffer) {}
	this.buzzPitch   = function(pitch) {}

	this.init = function(rom) {
		// initialise memory with a new array to ensure that it is of the right size and is initiliased to 0
		this.m = this.enableXO ? new Uint8Array(0x10000) : new Uint8Array(0x1000);

		this.p = [[], []];
		if (this.enableXO)
			for(var z = 0; z < 64*128; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
		else
			for(var z = 0; z < 32*64; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }

		// initialize memory
		var font = fontsets[this.fontStyle];
		for(var z = 0; z < 32*64;            z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
		for(var z = 0; z < font.small.length;z++) { this.m[z] = font.small[z]; }
		for(var z = 0; z < font.big.length;  z++) { this.m[z + font.small.length] = font.big[z]; }
		for(var z = 0; z < rom.rom.length;   z++) { this.m[0x200+z] = rom.rom[z]; }
		for(var z = 0; z < 16;               z++) { this.v[z] = 0; }
		for(var z = 0; z < 16;               z++) { this.pattern[z] = 0; }

		// initialize interpreter state
		this.r = [];
		this.pc = 0x200;
		this.i  = 0;
		this.dt = 0;
		this.st = 0;
		this.pitch = 64;
		this.hires = false;
		this.plane = 1;

		// initialize control/debug state
		this.keys = {};
		this.waiting = false;
		this.waitReg = -1;
		this.halted = false;
		this.breakpoint = false;
		this.stack_breakpoint = -1;
		this.metadata = rom;
		this.tickCounter = 0;
		this.profile_data = {};
	}

	this.writeCarry = function(dest, value, flag) {
		this.v[dest] = (value & 0xFF);
		this.v[0xF] = flag ? 1 : 0;
		if (this.vfOrderQuirks) {
			this.v[dest] = (value & 0xFF);
		}
	}

	this.math = function(x, y, op) {
		// basic arithmetic opcodes
		switch(op) {
			case 0x0: this.v[x]  = this.v[y]; break;
			case 0x1: this.v[x] |= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x2: this.v[x] &= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x3: this.v[x] ^= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x4:
				var t = this.v[x]+this.v[y];
				this.writeCarry(x, t, (t > 0xFF));
				break;
			case 0x5:
				var t = this.v[x]-this.v[y];
				this.writeCarry(x, t, (this.v[x] >= this.v[y]));
				break;
			case 0x7:
				var t = this.v[y]-this.v[x];
				this.writeCarry(x, t, (this.v[y] >= this.v[x]));
				break;
			case 0x6:
				if (this.shiftQuirks) { y = x; }
				var t = this.v[y] >> 1;
				this.writeCarry(x, t, (this.v[y] & 0x1));
				break;
			case 0xE:
				if (this.shiftQuirks) { y = x; }
				var t = this.v[y] << 1;
				this.writeCarry(x, t, ((this.v[y] >> 7) & 0x1));
				break;
			default:
				haltBreakpoint("unknown math opcode "+op.toString(16).toUpperCase());
		}
	}

	this.misc = function(x, rest) {
		// miscellaneous opcodes
		switch(rest) {
			case 0x01: this.plane = (x & 0x3); break;
			case 0x02:
				for(var z = 0; z < 16; z++) this.pattern[z] = this.m[this.i+z];
				this.buzzBuffer(this.pattern); break;
			case 0x07: this.v[x] = this.dt; break;
			case 0x0A: this.waiting = true; this.waitReg = x; break;
			case 0x15: this.dt = this.v[x]; break;
			case 0x18: this.buzzTimer(this.st = this.v[x]); break;
			case 0x1E: this.i = (this.i + this.v[x])&0xFFFF; break;
			case 0x29: this.i = ((this.v[x] & 0xF) * 5); break;
			case 0x30: this.i = ((this.v[x] & 0xF) * 10 + fontsets[this.fontStyle].small.length); break;
			case 0x33:
				this.m[this.i]   = Math.floor(this.v[x]/100)%10;
				this.m[this.i+1] = Math.floor(this.v[x]/10)%10;
				this.m[this.i+2] = this.v[x]%10;
				break;
			case 0x3A: this.buzzPitch(this.pitch = this.v[x]); break;
			case 0x55:
				for(var z = 0; z <= x; z++) { this.m[this.i+z] = this.v[z]; }
				if (!this.loadStoreQuirks) { this.i = (this.i+x+1)&0xFFFF; }
				break;
			case 0x65:
				for(var z = 0; z <= x; z++) { this.v[z] = this.m[this.i+z]; }
				if (!this.loadStoreQuirks) { this.i = (this.i+x+1)&0xFFFF; }
				break;
			case 0x75:
				for(var z = 0; z <= x; z++) { this.flags[z] = this.v[z]; }
				this.exportFlags(this.flags);
				break;
			case 0x85:
				this.flags = this.importFlags();
				if (typeof this.flags == "undefined" || this.flags == null) {
					this.flags = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
				}
				for(var z = 0; z <= x; z++) { this.v[z] = 0xFF & this.flags[z]; }
				break;
			default:
				haltBreakpoint("unknown misc opcode "+rest.toString(16).toUpperCase());
		}
	}

	this.sprite = function sprite(x, y, len) {
		this.v[0xF] = 0x0;
		var rowSize = this.hires ? 128 : 64;
		var colSize = this.hires ?  64 : 32;
		var i = this.i;
		for(var layer = 0; layer < 2; layer++) {
			if ((this.plane & (layer+1)) == 0) { continue; }
			if (len == 0) {
				// draw a SuperChip 16x16 sprite
				for(var a = 0; a < 16; a++) {
					for(var b = 0; b < 16; b++) {
						var target = ((x+b) % rowSize) + ((y+a) % colSize)*rowSize;
						var source = ((this.m[i+(a*2)+(b > 7 ? 1:0)] >> (7-(b%8))) & 0x1) != 0;
						if (this.clipQuirks) {
							if ((x%rowSize)+b>=rowSize || (y%colSize)+a>=colSize) { source = 0; }
						}
						if (!source) { continue; }
						if (this.p[layer][target]) { this.p[layer][target] = 0; this.v[0xF] = 0x1; }
						else { this.p[layer][target] = 1; }
					}
				}
				i += 32;
			}
			else {
				// draw a Chip8 8xN sprite
				for(var a = 0; a < len; a++) {
					for(var b = 0; b < 8; b++) {
						var target = ((x+b) % rowSize) + ((y+a) % colSize)*rowSize;
						var source = ((this.m[i+a] >> (7-b)) & 0x1) != 0;
						if (this.clipQuirks) {
							if ((x%rowSize)+b>=rowSize || (y%colSize)+a>=colSize) { source = 0; }
						}
						if (!source) { continue; }
						if (this.p[layer][target]) { this.p[layer][target] = 0; this.v[0xF] = 0x1; }
						else { this.p[layer][target] = 1; }
					}
				}
				i += len;
			}
		}
	}

	this.call = function(nnn) {
		if (this.r.length >= 12) {
			haltBreakpoint("call stack overflow.");
		}
		this.r.push(this.pc);
		this.pc = nnn
	}

	this.jump0 = function(nnn) {
		if (this.jumpQuirks) { this.pc = nnn + this.v[(nnn >> 8)&0xF];  }
		else                 { this.pc = nnn + this.v[0]; }
	}

	this.machine = function(nnn) {
		if (nnn == 0x000) { this.halted = true; return; }
		haltBreakpoint("machine code is not supported.");
	}

	this.skip = function() {
		var op = (this.m[this.pc  ] << 8) | this.m[this.pc+1];
		this.pc += (op == 0xF000) ? 4 : 2;
	}

	this.opcode = function() {
		// Increment profilining data
		this.profile_data[this.pc] = (this.profile_data[this.pc] || 0) + 1;

		// decode the current opcode
		var op  = (this.m[this.pc  ] << 8) | this.m[this.pc+1];
		var o   = (this.m[this.pc  ] >> 4) & 0x00F;
		var x   = (this.m[this.pc  ]     ) & 0x00F;
		var y   = (this.m[this.pc+1] >> 4) & 0x00F;
		var n   = (this.m[this.pc+1]     ) & 0x00F;
		var nn  = (this.m[this.pc+1]     ) & 0x0FF;
		var nnn = op & 0xFFF;
		this.pc += 2;

		// execute a simple opcode
		if (op == 0x00E0) {
			// clear
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = 0; z < this.p[layer].length; z++) {
					this.p[layer][z] = 0;
				}
			}
			return;
		}
		if (op == 0x00EE) {
			// return
			this.pc = this.r.pop();
			return;
		}
		if ((op & 0xF0FF) == 0xE09E) {
			// if -key
			if (Object.keys(keymap[this.v[x]]||{}).some(x => x in this.keys)) { this.skip(); }
			return;
		}
		if ((op & 0xF0FF) == 0xE0A1) {
			// if key
			if (!Object.keys(keymap[this.v[x]]||{}).some(x => x in this.keys)) { this.skip(); }
			return;
		}
		if ((op & 0xFFF0) == 0x00C0) {
			// scroll down n pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = this.p[layer].length - 1; z >= 0; z--) {
					this.p[layer][z] = (z >= rowSize * n) ? this.p[layer][z - (rowSize * n)] : 0;
				}
			}
			return;
		}
		if ((op & 0xFFF0) == 0x00D0) {
			// scroll up n pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = 0; z < this.p[layer].length; z++) {
					this.p[layer][z] = (z < (this.p[layer].length - rowSize * n)) ? this.p[layer][z + (rowSize * n)] : 0;
				}
			}
			return;
		}
		if (op == 0x00FB) {
			// scroll right 4 pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var a = 0; a < this.p[layer].length; a += rowSize) {
					for(var b = rowSize-1; b >= 0; b--) {
						this.p[layer][a + b] = (b > 3) ? this.p[layer][a + b - 4] : 0;
					}
				}
			}
			return;
		}
		if (op == 0x00FC) {
			// scroll left 4 pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var a = 0; a < this.p[layer].length; a += rowSize) {
					for(var b = 0; b < rowSize; b++) {
						this.p[layer][a + b] = (b < rowSize - 4) ? this.p[layer][a + b + 4] : 0;
					}
				}
			}
			return;
		}
		if (op == 0x00FD) {
			// exit
			this.halted = true;
			this.exitVector();
			return;
		}
		if (op == 0x00FE) {
			// lores
			this.hires = false;
			this.p = [[], []];
			for(var z = 0; z < 32*64; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
			return;
		}
		if (op == 0x00FF) {
			// hires
			this.hires = true;
			this.p = [[], []];
			for(var z = 0; z < 64*128; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
			return;
		}
		if (op == 0xF000) {
			// long memory reference
			this.i = ((this.m[this.pc] << 8) | (this.m[this.pc+1])) & 0xFFFF;
			this.pc += 2;
			return;
		}

		if (o == 0x5 && n != 0) {
			if (n == 2) {
				// save range
				var dist = Math.abs(x - y);
				if (x < y) { for(var z = 0; z <= dist; z++) { this.m[this.i+z] = this.v[x+z]; }}
				else       { for(var z = 0; z <= dist; z++) { this.m[this.i+z] = this.v[x-z]; }}
				return;
			}
			else if (n == 3) {
				// load range
				var dist = Math.abs(x - y);
				if (x < y) { for(var z = 0; z <= dist; z++) { this.v[x+z] = this.m[this.i+z]; }}
				else       { for(var z = 0; z <= dist; z++) { this.v[x-z] = this.m[this.i+z]; }}
				return;
			}
			else {
				haltBreakpoint("unknown opcode "+op.toString(16).toUpperCase());
			}
		}
		if (o == 0x9 && n != 0) {
			haltBreakpoint("unknown opcode "+op.toString(16).toUpperCase());
		}

		// dispatch complex opcodes
		switch(o) {
			case 0x0: this.machine(nnn);                            break;
			case 0x1: this.pc = nnn;                                break;
			case 0x2: this.call(nnn);                               break;
			case 0x3: if (this.v[x] == nn)        { this.skip(); }  break;
			case 0x4: if (this.v[x] != nn)        { this.skip(); }  break;
			case 0x5: if (this.v[x] == this.v[y]) { this.skip(); }  break;
			case 0x6: this.v[x] = nn;                               break;
			case 0x7: this.v[x] = (this.v[x] + nn) & 0xFF;          break;
			case 0x8: this.math(x, y, n);                           break;
			case 0x9: if (this.v[x] != this.v[y]) { this.skip(); }  break;
			case 0xA: this.i = nnn;                                 break;
			case 0xB: this.jump0(nnn);                              break;
			case 0xC: this.v[x] = (Math.random()*256)&nn;           break;
			case 0xD: this.sprite(this.v[x], this.v[y], n);         break;
			case 0xF: this.misc(x, nn);                             break;
			default: haltBreakpoint("unknown opcode "+o.toString(16).toUpperCase());
		}
	}

	this.tick = function() {
		if (this.halted) { return; }
		this.tickCounter++;
		try {
			this.opcode();
		}
		catch(err) {
			console.log("halted: " + err);
			this.halted = true;
		}
	}
}
</script>
<script>"use strict";

////////////////////////////////////
//
//   Emulator Execution
//
////////////////////////////////////

//must be set > 0
var scaleFactor = 5;
//dom id for canvas element
var renderTarget = "target";

const optionFlags = [
	"tickrate",
	"fillColor",
	"fillColor2",
	"blendColor",
	"backgroundColor",
	"buzzColor",
	"quietColor",
	"shiftQuirks",
	"loadStoreQuirks",
	"vfOrderQuirks",
	"clipQuirks",
	"vBlankQuirks",
	"jumpQuirks",
	"screenRotation",
	"maxSize",
	"touchInputMode",
	"logicQuirks",
	"fontStyle",
]
function unpackOptions(emulator, options) {
	optionFlags.forEach(x => { if (x in options) emulator[x] = options[x] })
	if (options["enableXO"]) emulator.maxSize = 65024 // legacy option
}
function packOptions(emulator) {
	const r = {}
	optionFlags.forEach(x => r[x] = emulator[x])
	return r
}

function setRenderTarget(scale, canvas) {
	scaleFactor = scale;
	renderTarget = canvas;
	var c = document.getElementById(canvas);

	// Remove any existing previous delta frame so first frame is always drawn:
	c.last = undefined;

	var w  = scaleFactor * 128;
	var h  = scaleFactor *  64;

	if (emulator.screenRotation == 90 || emulator.screenRotation == 270) {
		c.width  = h;
		c.height = w;
	}
	else {
		c.width  = w;
		c.height = h;
	}
}

function setTransform(emulator, g) {
	g.setTransform(1, 0, 0, 1, 0, 0);
	var x = scaleFactor * 128;
	var y = scaleFactor *  64;
	switch(emulator.screenRotation) {
		case 90:
			g.rotate(0.5 * Math.PI);
			g.translate(0, -y);
			break;
		case 180:
			g.rotate(1.0 * Math.PI);
			g.translate(-x, -y);
			break;
		case 270:
			g.rotate(1.5 * Math.PI);
			g.translate(-x, 0);
			break;
		default:
			console.assert(emulator.screenRotation === 0, 'Screen rotation not set to 0, 90, 180, or 270. Treating as 0.')
	}
}


function arrayEqual(a, b) {
	var length = a.length;
	if (length !== b.length) { return false; }
	for (var i = 0; i < length; i++) {
		if (a[i] !== b[i]) { return false; }
	}
	return true;
}

function getColor(id) {
	switch(id) {
		case 0: return emulator.backgroundColor;
		case 1: return emulator.fillColor;
		case 2: return emulator.fillColor2;
		case 3: return emulator.blendColor;
	}
	throw "invalid color: " + id;
}

function renderDisplay(emulator) {
	var c = document.getElementById(renderTarget);

	// Canvas rendering can be expensive. Exit out early if nothing has changed.
	var colors = [emulator.backgroundColor, emulator.fillColor, emulator.fillColor2, emulator.blendColor];
	if (c.last !== undefined) {
		if (arrayEqual(c.last.p[0], emulator.p[0]) && arrayEqual(c.last.p[1], emulator.p[1])
				&& arrayEqual(c.last.colors, colors)) {
			return;
		}
		if (c.last.hires !== emulator.hires)
			c.last = undefined;  // full redraw when switching resolution
	}
	var g = c.getContext("2d");
	setTransform(emulator, g);
	var w      = emulator.hires ? 128         : 64;
	var h      = emulator.hires ? 64          : 32;
	var size   = emulator.hires ? scaleFactor : scaleFactor*2;
	var lastPixels = c.last !== undefined? c.last.p: [[], []]

	g.scale(size, size)
	var z = 0;
	for(var y = 0; y < h; ++y) {
		for(var x = 0; x < w; ++x, ++z) {
			var oldColorIdx = lastPixels[0][z] + (lastPixels[1][z] << 1);
			var colorIdx = emulator.p[0][z] + (emulator.p[1][z] << 1);
			if (oldColorIdx !== colorIdx) {
				g.fillStyle = getColor(colorIdx);
				g.fillRect(x, y, 1, 1);
			}
		}
	}
	g.scale(1, 1) //restore scale to 1,1 just in case

	c.last = {
		colors: colors,
		p: [emulator.p[0].slice(), emulator.p[1].slice()],
		hires: emulator.hires,
	};
}

////////////////////////////////////
//
//   Audio Playback
//
////////////////////////////////////

var audio;
var audioNode;
var audioSource;
var audioData;
var XOAudio;

var AudioBuffer = function(buffer, duration) {
	if (!(this instanceof AudioBuffer)) {
		return new AudioBuffer(buffer, duration);
	}

	this.pointer = 0;
	this.buffer = buffer;
	this.duration = duration;
}

AudioBuffer.prototype.write = function(buffer, index, size) {
	size = Math.max(0, Math.min(size, this.duration))
	if (!size) { return size; }

	this.duration -= size;
	var bufferSize = this.buffer.length;
	var end = index + size;

	for(var i = index; i < end; ++i) {
		buffer[i] = this.buffer[this.pointer++];
		this.pointer %= bufferSize;
	}

	return size;
}

AudioBuffer.prototype.dequeue = function(duration) {
	this.duration -= duration;
}

var FREQ = 4000;
var PITCH_BIAS = 64;

function audioEnable() {
	// this will only work if called directly from a user-generated input handler:
	if (audio && audio.state == 'suspended') audio.resume()
}

function audioSetup(emulator) {
	if (!audio) {
		if (typeof AudioContext !== 'undefined') {
			audio = new AudioContext();
		}
		else if (typeof webkitAudioContext !== 'undefined') {
			audio = new webkitAudioContext();
		}
	}
	audioEnable()
	if (audio && !audioNode) {
		const bufferSize = // set bufferSize according to environment's samplerate
		audio.sampleRate <  64000 ? 2048 : // for 48000hz or 44100hz or less
		audio.sampleRate < 128000 ? 4096 : 8192; // for 96000hz or more
		audioNode = audio.createScriptProcessor(bufferSize, 1, 1);
		audioNode.gain = audio.createGain();
		audioNode.gain.gain.value = VOLUME ;
		audioNode.onaudioprocess = function(audioProcessingEvent) {
			var outputBuffer = audioProcessingEvent.outputBuffer;
			var outputData = outputBuffer.getChannelData(0);
			var samples_n = outputBuffer.length;
			var index = 0;
			while(audioData.length && index < samples_n) {
				var size = samples_n - index;
				var written = audioData[0].write(outputData, index, size);
				index += written;
				if (written < size) {
					audioData.shift();
				}
			}

			while(index < samples_n) {
				outputData[index++] = 0;
			}
			//the last one can be long sound with high value of buzzer, so always keep it
			if (audioData.length > 1) {
				var audioDataSize = 0;
				var audioBufferSize = audioNode.bufferSize;
				audioData.forEach(function(buffer) { audioDataSize += buffer.duration; })
				while(audioDataSize > audioBufferSize && audioData.length > 1) {
					audioDataSize -= audioData.shift().duration;
				}
			}
		}
		audioData = [];
		audioNode.connect(audioNode.gain);
		audioNode.gain.connect(audio.destination);

		XOAudio = new AudioControl();
		emulator.buzzTimer  = _ => XOAudio.setTimer(_);
		emulator.buzzBuffer = _ => XOAudio.setBuffer(_);
		emulator.buzzPitch  = _ => XOAudio.setPitch(_);
	}
	return audio && audioNode
}

function stopAudio() {
	if (!audio) { return; }
	if (audioNode) {
		audioNode.disconnect();
		audioNode = null;
	}
	audioData = [];
}

var VOLUME = 0.25;

function playPattern(soundLength,buffer,pitch=PITCH_BIAS,
	sampleState={ pos: 0 }) {
	if (!audio) { return; }
	audioEnable()

	var freq = FREQ*2**((pitch-PITCH_BIAS)/48);
	var samples = Math.ceil(audio.sampleRate * soundLength);
	
	var bufflen = buffer.length * 8;
	var audioBuffer = new Float32Array(samples);

	var step = freq / audio.sampleRate;
	var pos = sampleState.pos;

	// keep super-sampling consistent with audio sample rate
	var quality = Math.ceil( 384000 / audio.sampleRate );
	var lowPassAlpha = getLowPassAlpha(audio.sampleRate * quality);
	
	for(var i = 0, il = samples; i < il; i++) {
		for (var j = 0; j < quality; ++j) {
			var cell = pos >> 3, shift = pos & 7 ^ 7;
			var value = getLowPassFilteredValue(lowPassAlpha, buffer[cell] >> shift & 1);
			pos = ( pos + step/quality ) % bufflen;
		}
		audioBuffer[i] = value;
	}

	audioData.push(new AudioBuffer(audioBuffer, samples));
	
	return { pos };
}

const silentPattern = new Array(64).fill(0);

function AudioControl(){
	this.state = { pos: 0 };
	this.reset = true;
	this.buffer = [];

	this.timer = 0;
	this.pitch = PITCH_BIAS;

	this.refresh = _ => {
		if (this.reset) this.state.pos = 0; this.reset = false;
		if (this.timer == 0) playPattern(_,silentPattern);
		else this.state = playPattern(_,this.buffer,this.pitch,this.state);
		if((this.timer -= this.timer>0) == 0) this.reset = true;
		while(audioData.length > 8) audioData.shift();
	}
	this.setTimer = (timer) => {
		if(timer == 0) this.reset = true;
		this.timer = timer;
	}
	this.setBuffer = buffer => this.buffer = buffer;
	this.setPitch = pitch => this.pitch = pitch;
}

function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}

// Should be a good way below the Nyquist limit of 22.05 kHz.
const cutoffFrequency = 18000;

// How many filters to put in sequence.
const lowPassFilterSteps = 4;

// Each filter is an exponential filter, which mimics a simple analog RC filter.
// We need multiple of them in series to get decent attenuation near the stop band.

const lowPassBuffer = new Array(lowPassFilterSteps + 1).fill(0);

function getLowPassAlpha(samplingFrequency) {
	const c = Math.cos(2 * Math.PI * cutoffFrequency / samplingFrequency);
	return c - 1 + Math.sqrt(c * c - 4 * c + 3);
}

function getLowPassFilteredValue(alpha, targetValue) {
	lowPassBuffer[0] = targetValue;
	for (let i = 1; i < lowPassBuffer.length; ++i) {
		lowPassBuffer[i] += (lowPassBuffer[i - 1] - lowPassBuffer[i]) * alpha;
	}
	return lowPassBuffer[lowPassBuffer.length - 1];
}
</script>
<script>/**
* Adaptive Input
**/

const ael = (element, event, listener) => element.addEventListener   (event, listener, { passive:false })
const rel = (element, event, listener) => element.removeEventListener(event, listener, { passive:false })
const pd  = event => (event.preventDefault(),event.stopPropagation())

function addPointer(element,start,move,end){
  function mouseToTouch(f){
    return event=>{
      const to={indentifier:1,target:element,clientX:event.clientX,clientY:event.clientY}
      f({changedTouches:[to],touches:[to],preventDefault:_=>{},stopPropagation:_=>{}})
    }
  }
  let mousedown=false
  const events={
    touchstart: start,
    touchmove:  move,
    touchend:   end,
    mousedown:  mouseToTouch(e=>{mousedown=true;start(e)}),
    mousemove:  mouseToTouch(e=>{if(mousedown)move(e)}),
    mouseup:    mouseToTouch(e=>{mousedown=false;end(e)}),
    mouseout:   mouseToTouch(e=>{mousedown=false;end(e)}),
  }
  Object.keys(events).forEach(k=>ael(element,k,events[k]))
  return _=>{Object.keys(events).forEach(k=>rel(element,k,events[k]))}
}

const VIP_HEX  = '123c456d789ea0bf'.split('')
const VIP_KEYS = VIP_HEX.map(x => parseInt(x,16))

const GAMEPAD_STYLES = `
.gamepad{
  position:absolute;
  top:10%;
  left:0px;
  width:100%;
  height:90%;
  opacity:0.3;
  user-select: none;
  -webkit-user-select: none;
}
.gamepad .dpad{
  position:absolute;
  bottom: 50px;
  left:   50px;
  width:  250px;
  height: 250px;
  background: gray;
  border-radius: 50%;
  overflow:hidden;
}
.gamepad .stick{
  display:none;
  position:absolute;
  border-radius: 50%;
  width:100px;
  height:100px;
  margin-left:-50px;
  margin-top:-50px;
}
.gamepad .buttons{
  position:absolute;
  bottom: 50px;
  right:  50px;
  width:  250px;
  height: 250px;
}
.gamepad .gamebutton{
  position:absolute;
  width:  125px;
  height: 125px;
  background:gray;
  border-radius:50%;
  overflow:hidden;
  line-height: 125px;
  font-size:50px;
  font-weight:bold;
  color:darkgray;
  text-align:center;
}
.gamepad .dpad.active .stick {display:block;background:#444}
.gamepad .gamebutton.active{background:#444;}
.gamepad .gamebutton.b{left:0;bottom:0;}
.gamepad .gamebutton.a{right:0;top:0;}
`
const VIP_STYLES = `
.vip-pad {display:flex;flex-direction:column;align-items:center;z-index:2000;}
.vip-pad .keypad {display:flex;flex-direction:column;margin-top:10px;}
.vip-pad .keypad>div {display:flex;flex-direction:row;}
.vip-pad .keypad>div>div {
  -webkit-user-select: none;
  user-select: none;
  background:gray;
  width: 100px;
  height: 51px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 1px;
}
.vip-pad .keypad>div>div:active,
.vip-pad .keypad>div>div.active {background:black; border:1px solid white;margin:0px;}
`

const INPUT_MODULES = {
  /**
  * An invisible set of gesture recognizers,
  * giving directional input and an action for taps.
  **/
  swipe: {
    install: (screen,up,down,options) => {

      let vdirs      = []
      let direction  = { i:null, sx:0, sy:0, lx:0, ly:0 }
      let action1    = {}
      let taptimeout = null

      const updateStick = _ => {
        // find the relative position of the stick to its starting point
        const cx = direction.lx - direction.sx
        const cy = direction.ly - direction.sy

        // update the virtual direction buttons
        let t = []
        const DEAD_ZONE = 30
        if (Math.abs(cx) > DEAD_ZONE) t.push(cx < 0 ? options.left : options.right)
        if (Math.abs(cy) > DEAD_ZONE) t.push(cy < 0 ? options.up   : options.down)
        vdirs.forEach(x => (t    .indexOf(x)<0) && up  (x)) // clear keys no longer held
        t    .forEach(x => (vdirs.indexOf(x)<0) && down(x)) // push keys that were not held before
        vdirs = t
      }
      const tapDown= i => {
        if (Object.keys(action1).length == 0) down(options.action1)
        action1[i] = true
        if (i == direction.i) { direction = { i:null, sx:0, sy:0, lx:0, ly:0 } }
        taptimeout = null
      }
      const start = e => {
        const t = e.touches[0]
        const i = t.identifier
        // a single-touch is either directional or a tap...
        if (direction.i != null) {
          tapDown(i)
        }
        else {
          direction.i  = i
          direction.sx = t.clientX
          direction.sy = t.clientY
          direction.lx = t.clientX
          direction.ly = t.clientY
          taptimeout = setTimeout(_ => tapDown(i), 100)
        }
        updateStick(),pd(e)
      }
      const move = e => {
        for(let z = 0; z < e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i == direction.i) {
            if (taptimeout != null) { clearTimeout(taptimeout); taptimeout = null }
            direction.lx = t.clientX
            direction.ly = t.clientY
          }
        }
        updateStick(),pd(e)
      }
      const end = e => {
        let r1 = false
        for(let z = 0; z < e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i == direction.i) {
            if (taptimeout != null) {
              // cancel a short tap
              clearTimeout(taptimeout); taptimeout = null
              down(options.action1)
              setTimeout(_ => up(options.action1), 50)
            }
            direction = { i:null, sx:0, sy:0, lx:0, ly:0 }
          }
          if (i in action1) {
            delete action1[i]
            r1=true
          }
        }
        if (r1 && Object.keys(action1).length == 0) up(options.action1)
        updateStick(),pd(e)
      }
      ael(screen, 'touchstart', start)
      ael(screen, 'touchmove',  move)
      ael(screen, 'touchend',   end)
      screen.uninstallSwipe = _ => {
        rel(screen, 'touchstart', start)
        rel(screen, 'touchmove',  move)
        rel(screen, 'touchend',   end)
      }
    },
    remove: (screen) => {
      screen.uninstallSwipe()
      delete screen.uninstallSwipe
    }
  },

  /**
  * A virtual gamepad overlay with two remappable action keys.
  **/
  gamepad: {
    install: (screen,up,down,options) => {
      // build the UI
      if (document.querySelector('.gamepad')) return
      const root = document.createElement('div')
      root.classList.add('gamepad')
      root.innerHTML = `
      <div class='dpad'><div class='stick'></div></div>
      <div class='buttons'><div class='gamebutton b'>B</div><div class='gamebutton a'>A</div></div>
      <style>${GAMEPAD_STYLES}</style>`
      screen.parentElement.append(root)

      let vdirs      = []
      let directions = {}
      let buttons    = {}
      const pad   = document.querySelector('.gamepad .dpad')
      const stick = document.querySelector('.gamepad .dpad .stick')
      const a     = document.querySelector('.gamepad .gamebutton.a')
      const b     = document.querySelector('.gamepad .gamebutton.b')

      const updateStick = _ => {
        // find centroid of d-pad touchpoints ({0,0} if no touchpoints)
        const touches = Object.values(directions)
        let cx = 0, cy = 0, r = pad.getBoundingClientRect(), sr = stick.getBoundingClientRect()
        touches.forEach(t => (cx+=t.x, cy+=t.y))
        cx /= touches.length,         cy /= touches.length
        cx -= (r.left + (r.width/2)), cy -= (r.top + (r.height/2))

        // position the virtual stick, clamped within dpad
        const ca = Math.atan2(cy, cx)
        const cd = Math.min(Math.sqrt(cx*cx + cy*cy), (r.width/2)-(sr.width/2))
        stick.style.left = ((Math.cos(ca)*cd)+(r.width /2)|0)+'px'
        stick.style.top  = ((Math.sin(ca)*cd)+(r.height/2)|0)+'px'

        // update the virtual direction buttons
        let t = []
        const DEAD_ZONE = 30
        if (Math.abs(cx) > DEAD_ZONE) t.push(cx < 0 ? options.left : options.right)
        if (Math.abs(cy) > DEAD_ZONE) t.push(cy < 0 ? options.up   : options.down)
        vdirs.forEach(x => (t    .indexOf(x)<0) && up  (x)) // clear keys no longer held
        t    .forEach(x => (vdirs.indexOf(x)<0) && down(x)) // push keys that were not held before
        vdirs = t
      }

      const start = e => {
        for(let z = 0; z<e.touches.length; z++) {
          const t = e.touches[z]
          const i = t.identifier
          if (t.target == a) {
            t.target.classList.add('active')
            buttons[i]=options.action1
            down(options.action1)
          }
          if (t.target == b) {
            t.target.classList.add('active')
            buttons[i]=options.action2
            down(options.action2)
          }
          if (t.target == pad) {
            t.target.classList.add('active')
            directions[i]={x:t.clientX, y:t.clientY}
          }
        }
        updateStick(),pd(e)
      }
      const move = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i in directions) directions[i]={x:t.clientX, y:t.clientY}
        }
        updateStick(),pd(e)
      }
      const end = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i in buttons) {
            t.target.classList.remove('active')
            up(buttons[i])
            delete buttons[i]
          }
          if (i in directions) {
            t.target.classList.remove('active')
            delete directions[i]
          }
        }
        updateStick(),pd(e)
      }

      ael(a,   'touchstart', start)
      ael(a,   'touchend',   end  )
      ael(b,   'touchstart', start)
      ael(b,   'touchend',   end  )
      ael(pad, 'touchstart', start)
      ael(pad, 'touchmove',  move )
      ael(pad, 'touchend',   end  )
    },
    remove: (screen) => {
      document.querySelector('.gamepad').remove()
    },
  },

  /**
  * Treat the entire screen, or a centered square region, as invisible buttons,
  * mapped out in the order of the VIP hex keypad.
  **/
  seg16: {
    install: (screen,up,down,options) => {
      const tmap = {}
      const pointToKey = touch => {
        // poll this for each point, as it may vary over time,
        // and experimentally it's never right initially...
        const r = screen.getBoundingClientRect()
        if (options.mode == 'center') {
          if (r.width > r.height) { r.x += (r.width - r.height)/2; r.width = r.height }
          else                    { r.y += (r.height - r.width)/2; r.height = r.width }
        }
        const x = touch.clientX - r.x
        const y = touch.clientY - r.y
        if (x < 0 || x > r.width || y < 0 || y > r.height) return null
        const tx = Math.floor(x / (r.width /4))
        const ty = Math.floor(y / (r.height/4))
        return VIP_KEYS[tx + (4 * ty)]
      }
      const start = e => {
        for(let z=0; z<e.touches.length; z++) {
          const i = e.touches[z].identifier
          const k = pointToKey(e.touches[z])
          if (k != null) down(k)
          tmap[i]=k
        }
        pd(e)
      }
      const move = e => {
        for(let z=0; z<e.touches.length; z++) {
          const i = e.touches[z].identifier
          const k = pointToKey(e.touches[z])
          if (tmap[i] == k) continue       // same cell, nothing to do.
          if (tmap[i] != null) up(tmap[i]) // release old key, if any
          if (k != null)       down(k)     // press new key, if any
          tmap[i]=k
        }
        pd(e)
      }
      const end = e => {
        for(let z=0; z<e.changedTouches.length; z++) {
          const i = e.changedTouches[z].identifier
          const k = pointToKey(e.changedTouches[z])
          if (tmap[i] != null) up(tmap[i])
          tmap[i]=null
        }
        pd(e)
      }
      screen.uninstallSeg16=addPointer(screen,start,move,end)
    },
    remove:  (screen) => {
      screen.uninstallSeg16()
      delete screen.uninstallSeg16
    },
  },

  /**
  * Provide a visible 4x4 representation of the VIP hex keypad.
  **/
  vip: {
    install: (screen,up,down,options) => {
      if (document.querySelector('.vip-pad')) return
      const root = document.createElement('div')
      root.classList.add('vip-pad')
      root.innerHTML = `<div class='keypad'>
        ${[0,1,2,3].map(r=>`<div>${[0,1,2,3].map(c=>`<div>${VIP_HEX[c+(r*4)].toUpperCase()}</div>`).join('')}</div>`).join('')}
      </div>
      <style>${VIP_STYLES}</style>`
      if (screen.parentElement == document.body) { screen.parentElement.append(root) }
      else { screen.parentElement.parentElement.append(root) }
      const buttons = []
      document.querySelectorAll('.vip-pad .keypad>div>div').forEach(x=>buttons.push(x)) // make an actual Array
      const held = {}
      const start = e => {
        for(let z=0; z<e.touches.length; z++) {
          const t = e.touches[z]
          const i = t.identifier
          const k = VIP_KEYS[buttons.indexOf(t.target)]
          t.target.classList.add('active')
          down(k)
          held[i]=k
        }
        pd(e)
      }
      const end = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (held[i] != undefined) { up(held[i]); delete held[i] }
          t.target.classList.remove('active')
        }
        pd(e)
      }
      buttons.forEach(b => addPointer(b,start,_=>{},end))
    },
    remove:  (screen) => {
      document.querySelector('.vip-pad').remove()
    },
  },
}

let adaptiveControlsInstalled = null

function injectAdaptiveControls(type, screen, keyup, keydown) {
  let options = {
    up:      5,
    down:    8,
    left:    7,
    right:   9,
    action1: 6,
    action2: 4,
    mode:    'center', // or 'fill', used by seg16
  }
  const lookup = vk => Object.keys(keymap[vk])[0]
  const install = _ => {
    rel(screen, 'touchstart', install)
    rel(screen, 'mousedown',  install)
    adaptiveControlsInstalled = type
    INPUT_MODULES[type].install(
      screen,
      key => keyup  ({ key:lookup(key), preventDefault:_=>_ }),
      key => keydown({ key:lookup(key), preventDefault:_=>_ }),
      options
    )
  }
  // uninstall anything that's already there:
  rel(screen, 'touchstart', install)
  rel(screen, 'mousedown' , install)
  if (adaptiveControlsInstalled) INPUT_MODULES[adaptiveControlsInstalled].remove(screen)

  if (type == 'none') return
  if (type == 'seg16fill') { type='seg16'; options.mode='fill' }
  if (type in {seg16:1,seg16fill:1}){
    install()
  }
  else {
    // defer installing adaptive input until we actually see
    // an input event from the user:
    ael(screen, 'touchstart', install)
    ael(screen, 'mousedown',  install)
  }
}
</script>
<body><canvas id='target' width=512 height=256></canvas></body>
<style>body{margin:0px;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;}</style>
<script>
const emulator = new Emulator()
unpackOptions(emulator, data.options)
setRenderTarget(data.options.displayScale || 4, 'target')
emulator.init({rom:data.rom})
emulator.importFlags = _ => getPref('octoFlagRegisters')
emulator.exportFlags = f => setPref('octoFlagRegisters',f)
emulator.buzzTrigger = (ticks,rest)=> playPattern(ticks, emulator.pattern, rest)
const kd = e=>{
	if (!audio) audioSetup(emulator)
	if (!(e.key in emulator.keys)) emulator.keys[e.key]=true
	e.preventDefault()
}
const ku = e=>{
	if (e.key in emulator.keys) delete emulator.keys[e.key]
	if (!emulator.waiting) return
	const kindex = keymapInverse[e.key]
	if (kindex != undefined) {
		emulator.waiting = false
		emulator.v[emulator.waitReg] = kindex
	}
	e.preventDefault()
}
window.addEventListener('keydown',kd,false)
window.addEventListener('keyup',ku,false)
const frameTime=1000/60
let last=Date.now(), origin=last+frameTime/2
intervalHandle=setInterval(_=>{
	last+=(Date.now()-last)
	if (emulator.halted) return
	for(var k=0; origin<last-frameTime&&k<2; origin+=frameTime,k++){
		for(var z=0;(z<emulator.tickrate) && (!emulator.waiting); z++){
			if (emulator.vBlankQuirks &&((emulator.m[emulator.pc] & 0xF0)==0xD0)) z=emulator.tickrate
			emulator.tick()
		}
		if (emulator.dt > 0) emulator.dt--
		if (emulator.st > 0) emulator.st--
		XOAudio && XOAudio.refresh(frameTime/1000)
	}
	renderDisplay(emulator)
	document.body.style.backgroundColor = emulator.st?emulator.buzzColor:emulator.quietColor
}, frameTime)
injectAdaptiveControls(emulator.touchInputMode,document.getElementById('target'),ku,kd)
</script>
